<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Call Newsfeed - AI Sales Coach</title>
  <link rel="stylesheet" href="css/styles.css">
  <!-- Supabase JS SDK (local) -->
  <script src="js/supabase.min.js"></script>
  <script src="js/supabase-config.js"></script>
  <!-- Twilio Voice SDK for incoming calls -->
  <script src="js/twilio.min.js"></script>
  <style>
    /* Incoming Call Modal */
    .incoming-call-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;opacity:0;visibility:hidden;transition:all 0.3s ease;}
    .incoming-call-overlay.active{opacity:1;visibility:visible;}
    .incoming-call-modal{background:white;border-radius:16px;padding:24px;text-align:center;max-width:320px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);transform:scale(0.9);transition:transform 0.3s ease;}
    .incoming-call-overlay.active .incoming-call-modal{transform:scale(1);}
    .incoming-call-icon{width:80px;height:80px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;animation:ring-pulse 1.5s ease-in-out infinite;}
    .incoming-call-icon svg{width:40px;height:40px;color:white;animation:ring-shake 0.5s ease-in-out infinite;}
    @keyframes ring-pulse{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,0.4);}50%{box-shadow:0 0 0 20px rgba(16,185,129,0);}}
    @keyframes ring-shake{0%,100%{transform:rotate(-10deg);}50%{transform:rotate(10deg);}}
    .incoming-call-label{font-size:0.875rem;color:#6b7280;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
    .incoming-call-number{font-size:1.5rem;font-weight:600;color:#111827;margin-bottom:16px;}
    .incoming-call-actions{display:flex;gap:16px;justify-content:center;}
    .incoming-call-btn{width:70px;height:70px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;}
    .incoming-call-btn svg{width:28px;height:28px;color:white;}
    .incoming-call-btn.answer{background:linear-gradient(135deg,#10b981 0%,#059669 100%);}
    .incoming-call-btn.answer:hover{transform:scale(1.1);box-shadow:0 8px 20px rgba(16,185,129,0.4);}
    .incoming-call-btn.decline{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);}
    .incoming-call-btn.decline:hover{transform:scale(1.1);box-shadow:0 8px 20px rgba(239,68,68,0.4);}
    .incoming-call-btn-label{font-size:0.75rem;color:#4b5563;margin-top:4px;}
    .incoming-call-btn-wrapper{display:flex;flex-direction:column;align-items:center;}

    /* Newsfeed Specific Styles */
    .newsfeed-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }

    .newsfeed-filters {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .filter-btn {
      padding: var(--spacing-xs) var(--spacing-md);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-full);
      background: white;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .filter-btn .count {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.125rem 0.375rem;
      border-radius: var(--radius-full);
      margin-left: var(--spacing-xs);
      font-size: 0.625rem;
    }

    .filter-btn.active .count {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Feed Container */
    .feed-container {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    /* Feed Item Card */
    .feed-item {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      transition: all var(--transition-fast);
    }

    .feed-item:hover {
      box-shadow: var(--shadow-md);
    }

    .feed-item.untagged {
      border-left: 4px solid var(--warning);
    }

    .feed-item.booked {
      border-left: 4px solid var(--success);
    }

    .feed-item.estimate {
      border-left: 4px solid var(--primary);
    }

    .feed-item.question {
      border-left: 4px solid #8b5cf6;
    }

    .feed-item.current-customer {
      border-left: 4px solid #06b6d4;
    }

    .feed-item.missed {
      border-left: 4px solid var(--danger);
    }

    .feed-item.no-answer {
      border-left: 4px solid var(--gray-400);
    }

    /* Feed Item Header */
    .feed-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-md);
    }

    .feed-item-left {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .feed-item-status {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .feed-item-status.connected {
      background: var(--success-light);
    }

    .feed-item-status.missed {
      background: var(--danger-light);
    }

    .feed-item-status.no-answer {
      background: var(--gray-100);
    }

    .feed-item-info {
      display: flex;
      flex-direction: column;
    }

    .feed-item-phone {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .feed-item-meta {
      font-size: 0.75rem;
      color: var(--gray-500);
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-xs);
    }

    .feed-item-time {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    /* Call Result Badge */
    .call-result-badge {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .call-result-badge.connected {
      background: var(--success-light);
      color: #065f46;
    }

    .call-result-badge.missed {
      background: var(--danger-light);
      color: #991b1b;
    }

    .call-result-badge.no-answer {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    /* Quick Tag Buttons */
    .quick-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--gray-50);
      border-radius: var(--radius-md);
    }

    .quick-tags-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      margin-right: var(--spacing-sm);
      display: flex;
      align-items: center;
    }

    .tag-btn {
      padding: var(--spacing-xs) var(--spacing-md);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-md);
      background: white;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .tag-btn:hover {
      border-color: var(--gray-400);
    }

    .tag-btn.selected {
      border-width: 2px;
    }

    .tag-btn.booked {
      color: #065f46;
    }

    .tag-btn.booked:hover,
    .tag-btn.booked.selected {
      background: var(--success-light);
      border-color: var(--success);
    }

    .tag-btn.estimate {
      color: #1e40af;
    }

    .tag-btn.estimate:hover,
    .tag-btn.estimate.selected {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .tag-btn.question {
      color: #6d28d9;
    }

    .tag-btn.question:hover,
    .tag-btn.question.selected {
      background: #ede9fe;
      border-color: #8b5cf6;
    }

    .tag-btn.current-customer {
      color: #0e7490;
    }

    .tag-btn.current-customer:hover,
    .tag-btn.current-customer.selected {
      background: #cffafe;
      border-color: #06b6d4;
    }

    .tag-btn.not-interested {
      color: var(--gray-600);
    }

    .tag-btn.not-interested:hover,
    .tag-btn.not-interested.selected {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    /* Clickable Phone/Contact Link */
    .feed-item-phone-link {
      text-decoration: none;
      color: inherit;
      display: block;
      cursor: pointer;
      transition: color 0.15s ease;
    }

    .feed-item-phone-link:hover {
      color: var(--primary);
    }

    .feed-item-phone-link:hover .feed-item-phone {
      text-decoration: underline;
    }

    .feed-item-phone-small {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 2px;
    }

    /* Notes Section */
    .feed-item-notes {
      margin-top: var(--spacing-md);
    }

    .notes-display {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--gray-50);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .notes-display .notes-icon {
      color: var(--gray-400);
    }

    .notes-input-container {
      display: flex;
      gap: var(--spacing-sm);
    }

    .notes-input {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }

    /* Feed Item Actions */
    .feed-item-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--gray-100);
    }

    .action-buttons {
      display: flex;
      gap: var(--spacing-sm);
    }

    /* Transcript Preview */
    .transcript-preview {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--gray-50);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      color: var(--gray-600);
      max-height: 100px;
      overflow: hidden;
      position: relative;
    }

    .transcript-preview::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(transparent, var(--gray-50));
    }

    .transcript-preview.expanded {
      max-height: none;
    }

    .transcript-preview.expanded::after {
      display: none;
    }

    /* AI Summary */
    .ai-summary {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: var(--radius-md);
    }

    .ai-summary-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-weight: 600;
      color: #92400e;
      font-size: 0.75rem;
      text-transform: uppercase;
      margin-bottom: var(--spacing-sm);
    }

    .ai-summary-text {
      color: #78350f;
      font-size: 0.875rem;
    }

    /* Stats Summary */
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .stat-mini {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      text-align: center;
    }

    .stat-mini-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .stat-mini-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .stat-mini.total .stat-mini-value { color: var(--gray-700); }
    .stat-mini.booked .stat-mini-value { color: var(--success); }
    .stat-mini.estimate .stat-mini-value { color: var(--primary); }
    .stat-mini.untagged .stat-mini-value { color: var(--warning); }
    .stat-mini.missed .stat-mini-value { color: var(--danger); }

    /* New Call Animation */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .feed-item.new {
      animation: slideIn 0.3s ease-out;
    }

    /* Live indicator */
    .live-indicator {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: 0.75rem;
      color: var(--success);
      font-weight: 600;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: var(--radius-full);
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* New Calls Banner */
    .new-calls-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-md);
      padding: var(--spacing-sm) var(--spacing-md);
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-md);
      font-size: 0.875rem;
      font-weight: 500;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .new-calls-banner button {
      padding: var(--spacing-xs) var(--spacing-md);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .new-calls-banner button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .new-calls-banner .dismiss-btn {
      padding: var(--spacing-xs);
      border: none;
      background: none;
      font-size: 1.25rem;
      line-height: 1;
    }

    /* Pagination Controls */
    .pagination-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      margin-top: var(--spacing-md);
      flex-wrap: wrap;
      gap: var(--spacing-md);
    }

    .pagination-info {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .pagination-buttons {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .pagination-btn {
      padding: var(--spacing-xs) var(--spacing-md);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      background: white;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all var(--transition-fast);
      color: var(--gray-700);
    }

    .pagination-btn:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--primary-light);
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-current {
      font-weight: 600;
      color: var(--gray-700);
      padding: 0 var(--spacing-sm);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-summary {
        grid-template-columns: repeat(3, 1fr);
      }

      .newsfeed-filters {
        flex-wrap: wrap;
      }

      .quick-tags {
        flex-direction: column;
      }

      .pagination-controls {
        flex-direction: column;
        text-align: center;
      }

      .pagination-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* News Feed Section Styles */
    .news-feed-section {
      margin-bottom: var(--spacing-lg);
    }

    .news-feed-header {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-md);
      padding-left: var(--spacing-sm);
    }

    .feed-item.daily-stats {
      background: linear-gradient(135deg, #f5f3ff, #ede9fe);
      border-color: #c4b5fd;
    }

    .feed-item.daily-stats .feed-item-status.daily-stats-icon {
      background: var(--primary);
      color: white;
    }

    .daily-stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      background: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius-md);
      margin-top: var(--spacing-sm);
    }

    .daily-stat {
      text-align: center;
    }

    .daily-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .daily-stat-label {
      font-size: 0.625rem;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .feed-item.news-item {
      background: #f0f9ff;
      border-color: #bae6fd;
    }

    @media (max-width: 640px) {
      .daily-stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="sidebar-logo">
          <div class="sidebar-logo-icon">AI</div>
          <span class="sidebar-logo-text">Sales Coach</span>
        </a>
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
          <span>&#9664;</span>
        </button>
      </div>

      <nav class="sidebar-nav">
        <!-- Main Section -->
        <div class="sidebar-nav-section">
          <a href="dashboard.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìä</span>
            <span class="sidebar-nav-label">Dashboard</span>
          </a>
          <a href="newsfeed.html" class="sidebar-nav-item active">
            <span class="sidebar-nav-icon">üì∞</span>
            <span class="sidebar-nav-label">Newsfeed</span>
          </a>
          <a href="activity.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">‚ö°</span>
            <span class="sidebar-nav-label">Activity</span>
          </a>
        </div>

        <!-- Contacts Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">Contacts</div>
          <a href="contacts.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üë•</span>
            <span class="sidebar-nav-label">All Contacts</span>
          </a>
          <a href="contacts-import.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üì•</span>
            <span class="sidebar-nav-label">Import</span>
          </a>
        </div>

        <!-- Communication Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">Communication</div>
          <a href="sms.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üí¨</span>
            <span class="sidebar-nav-label">SMS</span>
            <span class="sidebar-nav-badge">3</span>
          </a>
          <a href="call.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìû</span>
            <span class="sidebar-nav-label">Make Call</span>
          </a>
          <a href="history.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìã</span>
            <span class="sidebar-nav-label">History</span>
          </a>
          <a href="callbacks.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üîî</span>
            <span class="sidebar-nav-label">Callbacks</span>
          </a>
        </div>

        <!-- AI Agent Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">AI Agent</div>
          <a href="agent-queue.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìã</span>
            <span class="sidebar-nav-label">Call Queue</span>
            <span class="sidebar-nav-badge" id="queueBadge">0</span>
          </a>
          <a href="agent-monitor.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">ü§ñ</span>
            <span class="sidebar-nav-label">Live Monitor</span>
          </a>
        </div>

        <!-- Sales Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">Sales</div>
          <a href="pipeline.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìà</span>
            <span class="sidebar-nav-label">Pipeline</span>
          </a>
        </div>

        <!-- Team Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">Team</div>
          <a href="supervisor.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üëÅÔ∏è</span>
            <span class="sidebar-nav-label">Supervisor</span>
          </a>
          <a href="supervisor-mockup.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìä</span>
            <span class="sidebar-nav-label">Team Overview</span>
          </a>
        </div>

        <!-- Settings -->
        <div class="sidebar-nav-section" style="margin-top: auto;">
          <a href="settings.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">‚öôÔ∏è</span>
            <span class="sidebar-nav-label">Settings</span>
          </a>
        </div>
      </nav>

      <!-- User Section -->
      <div class="sidebar-user">
        <div class="sidebar-user-avatar" id="userAvatar">SR</div>
        <div class="sidebar-user-info">
          <div class="sidebar-user-name">Sales Rep</div>
          <div class="sidebar-user-status" id="userStatus">
            <span class="status-dot"></span>
            <span id="connectionText">Connecting...</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Wrapper -->
    <div class="main-wrapper">
      <!-- Top Header -->
      <header class="top-header">
        <div class="top-header-left">
          <button class="mobile-menu-btn" onclick="openSidebar()">&#9776;</button>
          <h1 class="top-header-title">Call Newsfeed</h1>
        </div>
        <div class="top-header-right">
          <div class="live-indicator">
            <span class="live-dot"></span>
            <span>Live</span>
          </div>
          <div class="connection-status disconnected" id="connectionStatus">
            <span class="connection-dot"></span>
            <span>Disconnected</span>
          </div>
        </div>
      </header>

      <!-- Main Content Area -->
      <main class="main-content-area">
        <div class="newsfeed-header">
          <div class="newsfeed-filters">
          <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">
            All <span class="count" id="countAll">0</span>
          </button>
          <button class="filter-btn" data-filter="untagged" onclick="setFilter('untagged')">
            Needs Action <span class="count" id="countUntagged">0</span>
          </button>
          <button class="filter-btn" data-filter="booked" onclick="setFilter('booked')">
            Booked <span class="count" id="countBooked">0</span>
          </button>
          <button class="filter-btn" data-filter="estimate" onclick="setFilter('estimate')">
            Estimates <span class="count" id="countEstimate">0</span>
          </button>
          <button class="filter-btn" data-filter="missed" onclick="setFilter('missed')">
            Missed <span class="count" id="countMissed">0</span>
          </button>
        </div>
      </div>

      <!-- Stats Summary -->
      <div class="stats-summary">
        <div class="stat-mini total">
          <div class="stat-mini-value" id="statTotal">0</div>
          <div class="stat-mini-label">Total Calls Today</div>
        </div>
        <div class="stat-mini booked">
          <div class="stat-mini-value" id="statBooked">0</div>
          <div class="stat-mini-label">Booked Jobs</div>
        </div>
        <div class="stat-mini estimate">
          <div class="stat-mini-value" id="statEstimate">0</div>
          <div class="stat-mini-label">Estimates Given</div>
        </div>
        <div class="stat-mini untagged">
          <div class="stat-mini-value" id="statUntagged">0</div>
          <div class="stat-mini-label">Needs Action</div>
        </div>
        <div class="stat-mini missed">
          <div class="stat-mini-value" id="statMissed">0</div>
          <div class="stat-mini-label">Missed Calls</div>
        </div>
      </div>

        <!-- Feed Container - populated by newsfeed.js -->
        <div class="feed-container" id="feedContainer">
          <div class="loading-spinner">Loading calls...</div>
        </div>
      </main>

      <!-- Mobile Bottom Navigation -->
      <nav class="mobile-bottom-nav">
        <div class="mobile-nav-items">
          <a href="dashboard.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">&#128202;</span>
            <span>Dashboard</span>
          </a>
          <a href="newsfeed.html" class="mobile-nav-item active">
            <span class="mobile-nav-icon">&#128240;</span>
            <span>Feed</span>
          </a>
          <a href="history.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">&#128203;</span>
            <span>History</span>
          </a>
          <a href="callbacks.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">&#128276;</span>
            <span>Callbacks</span>
          </a>
        </div>
      </nav>

      <!-- Call FAB (mobile) -->
      <button class="call-fab" onclick="window.location.href='call.html'">&#128222;</button>
    </div>
  </div>

  <!-- Transcript Modal -->
  <div class="modal-overlay" id="transcriptModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">Call Transcript</h3>
        <button class="modal-close" onclick="closeTranscriptModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="transcriptContent" class="transcript-container">
          <!-- Transcript will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTranscriptModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Incoming Call Modal (ISSUE-211 FIX: Single instance only) -->
  <div class="incoming-call-overlay" id="incomingCallModal">
    <div class="incoming-call-modal">
      <div class="incoming-call-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
        </svg>
      </div>
      <div class="incoming-call-label">Incoming Call</div>
      <div class="incoming-call-number" id="incomingCallNumber">Unknown</div>
      <div class="incoming-call-actions">
        <div class="incoming-call-btn-wrapper">
          <button class="incoming-call-btn decline" id="declineCallBtn" title="Decline">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <span class="incoming-call-btn-label">Decline</span>
        </div>
        <div class="incoming-call-btn-wrapper">
          <button class="incoming-call-btn answer" id="answerCallBtn" title="Answer">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </button>
          <span class="incoming-call-btn-label">Answer</span>
        </div>
      </div>
    </div>
  </div>

  <!-- All functionality inline per CODING_STANDARDS.md -->
  <script>
    /**
     * Newsfeed Page JavaScript (Inlined from newsfeed.js)
     *
     * ISSUE-210 FIX: Auth check added with initPage({ requireAuth: true })
     * ISSUE-211 FIX: Duplicate modal removed - single modal above
     * ISSUE-212 FIX: Connection status updated dynamically
     * ISSUE-213 FIX: Live indicator tied to real-time connection
     * ISSUE-214 FIX: All logic migrated inline
     *
     * Security patterns from CODING_STANDARDS.md:
     * - Auth check first
     * - Filter by company_id
     * - Only select needed fields
     * - Use .limit() for lists
     * - escapeHtml() for XSS prevention
     */

    // ===========================================
    // STATE
    // ===========================================
    let calls = []
    let currentFilter = 'all'
    let companyId = null
    let newsFeedItems = []  // News feed items (daily stats, etc.)

    // Pagination state
    let currentPage = 1
    const PAGE_SIZE = 10
    let totalPages = 1

    // Twilio Device for incoming calls
    let twilioDevice = null;
    let pendingIncomingCall = null;
    let ringtoneAudio = null;
    const repIdentity = 'sales-rep';

    // Real-time subscription
    let realtimeChannel = null;

    // ===========================================
    // INITIALIZATION (ISSUE-210 FIX: Auth check)
    // ===========================================

    document.addEventListener('DOMContentLoaded', () => {
      initPage({
        requireAuth: true,
        onReady: async (user) => {
          // Update user display
          if (user) {
            const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User'
            const userNameEl = document.getElementById('userAvatar')
            if (userNameEl) userNameEl.textContent = name.charAt(0).toUpperCase()
            const userStatusEl = document.getElementById('connectionText')
            if (userStatusEl) userStatusEl.textContent = 'Available'
          }

          // Get company membership
          const membership = await getCompanyMembership()
          if (membership.error || !membership.companyId) {
            showError('#feedContainer', 'Unable to load newsfeed. Please try again.')
            return
          }
          companyId = membership.companyId

          // Load initial data
          await loadCalls()

          // ISSUE-212/213 FIX: Set up real-time subscription and update indicators
          setupRealtimeSubscription()

          // Initialize Twilio for incoming calls
          initTwilioDevice()
        },
        onError: (error) => {
          console.error('Newsfeed page init error:', error)
          showError('#feedContainer', 'Failed to load newsfeed')
          // ISSUE-212 FIX: Update connection status on error
          updateConnectionStatus(false)
        }
      })
    })

    // ===========================================
    // DATA LOADING
    // ===========================================

    async function loadCalls() {
      if (!companyId) {
        console.error('No company ID available')
        return
      }

      try {
        showLoading('#feedContainer', 'Loading calls...')

        const now = new Date()
        const today = new Date(now)
        today.setHours(0, 0, 0, 0)
        const todayIso = today.toISOString()

        const weekAgo = new Date(now)
        weekAgo.setDate(weekAgo.getDate() - 7)
        const weekAgoIso = weekAgo.toISOString()

        // First try to load today's calls
        let { data, error } = await supabase
          .from('calls')
          .select(`
            id, external_call_id, phone_number, direction, status, outcome,
            duration_seconds, ai_summary, notes, started_at, ended_at,
            contact:contacts(id, first_name, last_name, business_name)
          `)
          .eq('company_id', companyId)
          .gte('started_at', todayIso)
          .order('started_at', { ascending: false })
          .limit(50)

        if (error) {
          console.error('Error loading calls:', error)
          showError('#feedContainer', 'Failed to load calls: ' + error.message)
          return
        }

        // If no calls today, try loading recent calls
        if (!data || data.length === 0) {
          console.log('No calls today, loading recent calls...')
          const recentResult = await supabase
            .from('calls')
            .select(`
              id, external_call_id, phone_number, direction, status, outcome,
              duration_seconds, ai_summary, notes, started_at, ended_at,
              contact:contacts(id, first_name, last_name, business_name)
            `)
            .eq('company_id', companyId)
            .gte('started_at', weekAgoIso)
            .order('started_at', { ascending: false })
            .limit(50)

          if (!recentResult.error) {
            data = recentResult.data
            const headerTitle = document.querySelector('.top-header-title')
            if (headerTitle && data && data.length > 0) {
              headerTitle.textContent = 'Recent Calls (This Week)'
            }
          }
        }

        calls = transformCallsData(data || [])

        // Also load news feed items (daily stats, etc.)
        await loadNewsFeedItems()

        renderFeed()
        updateStats()
        updateFilterCounts()

      } catch (error) {
        console.error('Load calls error:', error)
        showError('#feedContainer', 'Failed to load calls: ' + error.message)
      }
    }

    // Load news feed items (daily stats, achievements, etc.)
    async function loadNewsFeedItems() {
      if (!companyId) return

      try {
        const today = new Date()
        const sevenDaysAgo = new Date(today)
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)

        const { data, error } = await supabase
          .from('news_feed')
          .select('id, type, title, content, icon, priority, created_at')
          .eq('company_id', companyId)
          .gte('created_at', sevenDaysAgo.toISOString())
          .order('created_at', { ascending: false })
          .limit(20)

        if (error) {
          console.error('Error loading news feed:', error)
          return
        }

        newsFeedItems = data || []

      } catch (error) {
        console.error('Load news feed error:', error)
      }
    }

    // Render a news feed item card
    function renderNewsFeedItem(item) {
      if (item.type === 'daily_rep_stats') {
        const content = item.content || {}
        const date = content.date ? new Date(content.date).toLocaleDateString() : ''

        return `
          <div class="feed-item daily-stats" data-news-id="${escapeHtml(item.id)}">
            <div class="feed-item-header">
              <div class="feed-item-left">
                <div class="feed-item-status daily-stats-icon">${item.icon || '&#128202;'}</div>
                <div class="feed-item-info">
                  <div class="feed-item-phone">${escapeHtml(item.title)}</div>
                  <div class="feed-item-meta">
                    <span>${escapeHtml(date)}</span>
                  </div>
                </div>
              </div>
              <span class="badge badge-info">Daily Stats</span>
            </div>
            <div class="daily-stats-grid">
              <div class="daily-stat">
                <div class="daily-stat-value">${content.total_calls || 0}</div>
                <div class="daily-stat-label">Calls</div>
              </div>
              <div class="daily-stat">
                <div class="daily-stat-value">${content.connected_calls || 0}</div>
                <div class="daily-stat-label">Connected</div>
              </div>
              <div class="daily-stat">
                <div class="daily-stat-value">${content.booked_calls || 0}</div>
                <div class="daily-stat-label">Booked</div>
              </div>
              <div class="daily-stat">
                <div class="daily-stat-value">${content.calls_per_hour || 0}</div>
                <div class="daily-stat-label">Calls/Hr</div>
              </div>
              <div class="daily-stat">
                <div class="daily-stat-value">${content.productivity_score || 0}%</div>
                <div class="daily-stat-label">Talk Time</div>
              </div>
              <div class="daily-stat">
                <div class="daily-stat-value">${content.talk_time_minutes || 0}m</div>
                <div class="daily-stat-label">On Calls</div>
              </div>
            </div>
          </div>
        `
      }

      // Default news item rendering
      return `
        <div class="feed-item news-item" data-news-id="${escapeHtml(item.id)}">
          <div class="feed-item-header">
            <div class="feed-item-left">
              <div class="feed-item-status">${item.icon || '&#128240;'}</div>
              <div class="feed-item-info">
                <div class="feed-item-phone">${escapeHtml(item.title)}</div>
                <div class="feed-item-meta">
                  <span>${escapeHtml(formatRelativeTime(item.created_at))}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `
    }

    function transformCallsData(data) {
      return data.map(call => ({
        id: call.id,
        callSid: call.external_call_id || call.id,
        phoneNumber: call.phone_number,
        direction: call.direction,
        status: call.status,
        outcome: call.outcome,
        duration: call.duration_seconds,
        notes: call.notes || null,
        aiSummary: call.ai_summary,
        transcript: [],
        startTime: call.started_at,
        endTime: call.ended_at,
        contact: call.contact
      }))
    }

    // ===========================================
    // REAL-TIME UPDATES (ISSUE-212/213 FIX)
    // ===========================================

    function setupRealtimeSubscription() {
      if (!companyId) return

      realtimeChannel = supabase
        .channel('calls-newsfeed')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'calls',
          filter: `company_id=eq.${companyId}`
        }, (payload) => {
          handleRealtimeUpdate(payload)
        })
        .subscribe((status) => {
          // ISSUE-212/213 FIX: Update connection status based on subscription
          if (status === 'SUBSCRIBED') {
            updateConnectionStatus(true)
            showLiveIndicator(true)
          } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
            updateConnectionStatus(false)
            showLiveIndicator(false)
          }
        })
    }

    function handleRealtimeUpdate(payload) {
      const { eventType, new: newRecord, old: oldRecord } = payload

      if (eventType === 'INSERT') {
        const callDate = new Date(newRecord.started_at)
        const today = new Date()
        today.setHours(0, 0, 0, 0)

        if (callDate >= today) {
          const transformedCall = transformCallsData([newRecord])[0]
          calls.unshift(transformedCall)

          if (currentPage === 1) {
            renderFeed()
          } else {
            showNewCallsBanner()
          }
          updateStats()
          updateFilterCounts()
        }
      } else if (eventType === 'UPDATE') {
        const index = calls.findIndex(c => c.id === newRecord.id)
        if (index !== -1) {
          calls[index] = transformCallsData([newRecord])[0]
          renderFeed()
          updateStats()
          updateFilterCounts()
        }
      }
    }

    // ISSUE-212 FIX: Update connection status dynamically
    function updateConnectionStatus(connected) {
      const status = document.getElementById('connectionStatus')
      const userStatus = document.getElementById('userStatus')
      const connectionText = document.getElementById('connectionText')

      if (connected) {
        if (status) {
          status.className = 'connection-status connected'
          status.innerHTML = '<span class="connection-dot"></span><span>Connected</span>'
        }
        if (userStatus) userStatus.style.color = 'var(--success)'
        if (connectionText) connectionText.textContent = 'Available'
      } else {
        if (status) {
          status.className = 'connection-status disconnected'
          status.innerHTML = '<span class="connection-dot"></span><span>Disconnected</span>'
        }
        if (userStatus) userStatus.style.color = 'var(--gray-400)'
        if (connectionText) connectionText.textContent = 'Offline'
      }
    }

    // ISSUE-213 FIX: Show/hide live indicator based on real connection
    function showLiveIndicator(show) {
      const liveIndicator = document.querySelector('.live-indicator')
      if (liveIndicator) {
        liveIndicator.style.display = show ? 'flex' : 'none'
      }
    }

    function showNewCallsBanner() {
      let banner = document.getElementById('newCallsBanner')

      if (!banner) {
        banner = document.createElement('div')
        banner.id = 'newCallsBanner'
        banner.className = 'new-calls-banner'
        banner.innerHTML = `
          <span>New calls available!</span>
          <button onclick="goToFirstPage()">View Latest</button>
          <button class="dismiss-btn" onclick="dismissNewCallsBanner()">x</button>
        `
        const feedContainer = document.getElementById('feedContainer')
        feedContainer.parentNode.insertBefore(banner, feedContainer)
      }

      banner.style.display = 'flex'
    }

    function goToFirstPage() {
      dismissNewCallsBanner()
      goToPage(1)
    }
    window.goToFirstPage = goToFirstPage

    function dismissNewCallsBanner() {
      const banner = document.getElementById('newCallsBanner')
      if (banner) banner.style.display = 'none'
    }
    window.dismissNewCallsBanner = dismissNewCallsBanner

    // ===========================================
    // RENDERING
    // ===========================================

    function renderFeed() {
      const container = document.getElementById('feedContainer')
      const filteredCalls = filterCalls(calls)

      // Build the feed content
      let feedContent = ''

      // Add news feed items at the top (only on first page and 'all' filter)
      if (currentPage === 1 && currentFilter === 'all' && newsFeedItems.length > 0) {
        feedContent += '<div class="news-feed-section">'
        feedContent += '<div class="news-feed-header">Recent Stats</div>'
        feedContent += newsFeedItems.slice(0, 3).map(item => renderNewsFeedItem(item)).join('')
        feedContent += '</div>'
      }

      if (filteredCalls.length === 0) {
        if (feedContent) {
          // Show news items even if no calls
          container.innerHTML = feedContent + `
            <div class="empty-state">
              <div class="empty-state-icon">&#128222;</div>
              <div class="empty-state-title">No calls yet today</div>
              <div class="empty-state-text">Calls will appear here as they come in</div>
            </div>
          `
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">&#128222;</div>
              <div class="empty-state-title">${currentFilter === 'all' ? 'No calls yet today' : 'No matching calls'}</div>
              <div class="empty-state-text">${currentFilter === 'all' ? 'Calls will appear here as they come in' : 'Try a different filter'}</div>
            </div>
          `
        }
        renderPagination(0)
        return
      }

      totalPages = Math.ceil(filteredCalls.length / PAGE_SIZE)
      if (currentPage > totalPages) currentPage = totalPages
      if (currentPage < 1) currentPage = 1

      const startIndex = (currentPage - 1) * PAGE_SIZE
      const endIndex = startIndex + PAGE_SIZE
      const paginatedCalls = filteredCalls.slice(startIndex, endIndex)

      feedContent += paginatedCalls.map(call => renderFeedItem(call)).join('')
      container.innerHTML = feedContent
      renderPagination(filteredCalls.length)
    }

    function renderPagination(totalItems) {
      let paginationContainer = document.getElementById('paginationControls')

      if (!paginationContainer) {
        paginationContainer = document.createElement('div')
        paginationContainer.id = 'paginationControls'
        paginationContainer.className = 'pagination-controls'
        const feedContainer = document.getElementById('feedContainer')
        feedContainer.parentNode.insertBefore(paginationContainer, feedContainer.nextSibling)
      }

      if (totalItems === 0 || totalPages <= 1) {
        paginationContainer.innerHTML = ''
        return
      }

      paginationContainer.innerHTML = `
        <div class="pagination-info">
          Showing ${((currentPage - 1) * PAGE_SIZE) + 1}-${Math.min(currentPage * PAGE_SIZE, totalItems)} of ${totalItems} calls
        </div>
        <div class="pagination-buttons">
          <button class="pagination-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
          <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
          <span class="pagination-current">Page ${currentPage} of ${totalPages}</span>
          <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
          <button class="pagination-btn" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
        </div>
      `
    }

    function goToPage(page) {
      if (page < 1 || page > totalPages) return
      currentPage = page
      renderFeed()
      document.getElementById('feedContainer')?.scrollIntoView({ behavior: 'smooth', block: 'start' })
    }
    window.goToPage = goToPage

    function isConnectedCall(status) {
      return status === 'connected' || status === 'completed' || status === 'in_progress'
    }

    function isMissedCall(call) {
      const missedStatuses = ['missed', 'no-answer', 'no_answer']
      if (call.direction === 'inbound') {
        return missedStatuses.includes(call.status) || call.status === 'initiated' || call.status === 'ringing'
      }
      return missedStatuses.includes(call.status)
    }

    function filterCalls(callsList) {
      switch (currentFilter) {
        case 'untagged':
          return callsList.filter(c => isConnectedCall(c.status) && !c.outcome)
        case 'booked':
          return callsList.filter(c => c.outcome === 'booked')
        case 'estimate':
          return callsList.filter(c => c.outcome === 'estimate')
        case 'missed':
          return callsList.filter(c => isMissedCall(c))
        default:
          return callsList
      }
    }

    function renderFeedItem(call) {
      const isConnected = isConnectedCall(call.status)
      const isMissed = isMissedCall(call)
      const outcomeClass = call.outcome || (isConnected ? 'untagged' : (isMissed ? 'missed' : call.status))
      const statusIcon = isConnected ? '‚úÖ' : (isMissed ? 'üìµ' : 'üìû')
      const needsAction = isConnected && !call.outcome

      const safePhoneNumber = escapeHtml(formatPhoneNumber(call.phoneNumber))
      const safeCallSid = escapeHtml(call.callSid || call.id)
      const safeNotes = call.notes ? escapeHtml(call.notes) : ''
      const safeAiSummary = call.aiSummary ? escapeHtml(call.aiSummary) : ''

      const contactId = call.contact?.id || null
      const contactName = call.contact
        ? escapeHtml([call.contact.first_name, call.contact.last_name].filter(Boolean).join(' ') || call.contact.business_name || '')
        : ''
      const profileUrl = contactId
        ? `contact-profile.html?id=${contactId}`
        : `contact-profile.html?phone=${encodeURIComponent(call.phoneNumber)}`

      return `
        <div class="feed-item ${escapeHtml(outcomeClass)}" data-call-id="${safeCallSid}">
          <div class="feed-item-header">
            <div class="feed-item-left">
              <div class="feed-item-status ${escapeHtml(call.status)}">${statusIcon}</div>
              <div class="feed-item-info">
                <a href="${profileUrl}" class="feed-item-phone-link" title="View contact profile">
                  <div class="feed-item-phone">${contactName || safePhoneNumber}</div>
                  ${contactName ? `<div class="feed-item-phone-small">${safePhoneNumber}</div>` : ''}
                </a>
                <div class="feed-item-meta">
                  <span>${escapeHtml(formatRelativeTime(call.startTime))}</span>
                  ${call.duration ? `<span>${escapeHtml(formatDuration(call.duration))}</span>` : ''}
                </div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
              ${call.outcome ? `<span class="badge badge-${getOutcomeBadgeClass(call.outcome)}">${escapeHtml(formatOutcome(call.outcome))}</span>` : ''}
              <span class="call-result-badge ${escapeHtml(call.status)}">${escapeHtml(formatStatus(call.status))}</span>
            </div>
          </div>

          ${isConnected ? `
            <div class="quick-tags">
              <span class="quick-tags-label">${needsAction ? 'Tag this call:' : 'Outcome:'}</span>
              <button class="tag-btn booked ${call.outcome === 'booked' ? 'selected' : ''}" onclick="tagCall('${safeCallSid}', 'booked')">Booked</button>
              <button class="tag-btn estimate ${call.outcome === 'estimate' ? 'selected' : ''}" onclick="tagCall('${safeCallSid}', 'estimate')">Gave Estimate</button>
              <button class="tag-btn question ${call.outcome === 'question' ? 'selected' : ''}" onclick="tagCall('${safeCallSid}', 'question')">Question</button>
              <button class="tag-btn current-customer ${call.outcome === 'current_customer' ? 'selected' : ''}" onclick="tagCall('${safeCallSid}', 'current_customer')">Current Customer</button>
              <button class="tag-btn not-interested ${call.outcome === 'not_interested' ? 'selected' : ''}" onclick="tagCall('${safeCallSid}', 'not_interested')">Not Interested</button>
            </div>
          ` : ''}

          ${safeAiSummary ? `
            <div class="ai-summary">
              <div class="ai-summary-header"><span>ü§ñ</span> AI Summary</div>
              <div class="ai-summary-text">${safeAiSummary}</div>
            </div>
          ` : ''}

          <div class="feed-item-notes">
            ${safeNotes ? `
              <div class="notes-display">
                <span class="notes-icon">üìù</span>
                <span>${safeNotes}</span>
                <button class="btn btn-sm btn-secondary" onclick="editNotes('${safeCallSid}')" style="margin-left: auto;">Edit</button>
              </div>
            ` : `
              <div class="notes-input-container" id="notes-${safeCallSid}">
                <input type="text" class="notes-input" placeholder="Add notes..." onkeypress="handleNotesKeypress(event, '${safeCallSid}')" maxlength="500">
                <button class="btn btn-sm btn-primary" onclick="saveNotes('${safeCallSid}')">Save</button>
              </div>
            `}
          </div>

          <div class="feed-item-actions">
            <div class="action-buttons">
              <button class="btn btn-sm btn-success" onclick="callBack('${escapeHtml(call.phoneNumber)}')">üìû Call Back</button>
              ${isMissedCall(call) ? `<button class="btn btn-sm btn-warning" onclick="scheduleCallback('${safeCallSid}', '${escapeHtml(call.phoneNumber)}')">üìÖ Schedule Callback</button>` : ''}
            </div>
            <span class="text-xs text-muted">${escapeHtml(formatDateTime(call.startTime))}</span>
          </div>
        </div>
      `
    }

    // ===========================================
    // CALL ACTIONS
    // ===========================================

    async function tagCall(callId, outcome) {
      if (!callId || typeof callId !== 'string') return

      const validOutcomes = ['booked', 'estimate', 'question', 'current_customer', 'not_interested', null]
      if (outcome !== null && !validOutcomes.includes(outcome)) return

      const call = calls.find(c => (c.callSid || c.id) === callId)
      if (!call) return

      const newOutcome = call.outcome === outcome ? null : outcome

      try {
        const { error } = await supabase
          .from('calls')
          .update({ outcome: newOutcome })
          .eq('company_id', companyId)
          .eq('id', call.id)

        if (error) {
          console.error('Error updating call outcome:', error)
          return
        }

        call.outcome = newOutcome
        renderFeed()
        updateStats()
        updateFilterCounts()

      } catch (error) {
        console.error('Tag call error:', error)
      }
    }
    window.tagCall = tagCall

    async function saveNotes(callId) {
      if (!callId || typeof callId !== 'string') return

      const container = document.getElementById(`notes-${callId}`)
      if (!container) return

      const input = container.querySelector('input')
      const notes = input.value.trim()

      if (notes.length > 500) {
        alert('Notes must be 500 characters or less')
        return
      }

      const call = calls.find(c => (c.callSid || c.id) === callId)
      if (!call) return

      try {
        const { error } = await supabase
          .from('calls')
          .update({ notes: notes })
          .eq('company_id', companyId)
          .eq('id', call.id)

        if (error) {
          console.error('Error saving notes:', error)
          return
        }

        call.notes = notes
        renderFeed()

      } catch (error) {
        console.error('Save notes error:', error)
      }
    }
    window.saveNotes = saveNotes

    function handleNotesKeypress(event, callId) {
      if (event.key === 'Enter') saveNotes(callId)
    }
    window.handleNotesKeypress = handleNotesKeypress

    function editNotes(callId) {
      const call = calls.find(c => (c.callSid || c.id) === callId)
      if (!call) return

      const newNotes = prompt('Edit notes:', call.notes || '')
      if (newNotes !== null && newNotes.length <= 500) {
        call.notes = newNotes
        saveNotesDirectly(call.id, newNotes)
        renderFeed()
      } else if (newNotes && newNotes.length > 500) {
        alert('Notes must be 500 characters or less')
      }
    }
    window.editNotes = editNotes

    async function saveNotesDirectly(callDbId, notes) {
      try {
        await supabase
          .from('calls')
          .update({ notes: notes })
          .eq('company_id', companyId)
          .eq('id', callDbId)
      } catch (error) {
        console.error('Save notes error:', error)
      }
    }

    function viewTranscript(callId) {
      const call = calls.find(c => (c.callSid || c.id) === callId)
      if (!call || !call.transcript || call.transcript.length === 0) return

      const content = document.getElementById('transcriptContent')
      content.innerHTML = call.transcript.map(t => `
        <div class="transcript-message ${escapeHtml(t.speaker || 'unknown')}">
          <div>${escapeHtml(t.text || '')}</div>
          <div class="transcript-time">${escapeHtml(t.time || '')}</div>
        </div>
      `).join('')

      document.getElementById('transcriptModal').classList.add('active')
    }
    window.viewTranscript = viewTranscript

    function closeTranscriptModal() {
      document.getElementById('transcriptModal').classList.remove('active')
    }
    window.closeTranscriptModal = closeTranscriptModal

    function callBack(phoneNumber) {
      if (!phoneNumber) return
      window.location.href = `call.html?number=${encodeURIComponent(phoneNumber)}`
    }
    window.callBack = callBack

    function scheduleCallback(callId, phoneNumber) {
      if (!phoneNumber) return
      window.location.href = `callbacks.html?schedule=${encodeURIComponent(phoneNumber)}`
    }
    window.scheduleCallback = scheduleCallback

    // ===========================================
    // FILTERS & STATS
    // ===========================================

    function setFilter(filter) {
      currentFilter = filter
      currentPage = 1
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter)
      })
      renderFeed()
    }
    window.setFilter = setFilter

    function updateFilterCounts() {
      const counts = {
        all: calls.length,
        untagged: calls.filter(c => isConnectedCall(c.status) && !c.outcome).length,
        booked: calls.filter(c => c.outcome === 'booked').length,
        estimate: calls.filter(c => c.outcome === 'estimate').length,
        missed: calls.filter(c => isMissedCall(c)).length
      }

      document.getElementById('countAll').textContent = counts.all
      document.getElementById('countUntagged').textContent = counts.untagged
      document.getElementById('countBooked').textContent = counts.booked
      document.getElementById('countEstimate').textContent = counts.estimate
      document.getElementById('countMissed').textContent = counts.missed
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = calls.length
      document.getElementById('statBooked').textContent = calls.filter(c => c.outcome === 'booked').length
      document.getElementById('statEstimate').textContent = calls.filter(c => c.outcome === 'estimate').length
      document.getElementById('statUntagged').textContent = calls.filter(c => isConnectedCall(c.status) && !c.outcome).length
      document.getElementById('statMissed').textContent = calls.filter(c => isMissedCall(c)).length
    }

    // ===========================================
    // FORMATTING HELPERS
    // ===========================================

    function formatPhoneNumber(number) {
      if (!number) return ''
      const cleaned = number.replace(/\D/g, '')
      if (cleaned.length === 11 && cleaned[0] === '1') {
        return `+1 (${cleaned.slice(1, 4)}) ${cleaned.slice(4, 7)}-${cleaned.slice(7)}`
      }
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`
      }
      return number
    }

    function formatDuration(seconds) {
      if (!seconds) return '0:00'
      const mins = Math.floor(seconds / 60)
      const secs = Math.floor(seconds % 60)
      return `${mins}:${secs.toString().padStart(2, '0')}`
    }

    function formatRelativeTime(dateStr) {
      if (!dateStr) return ''
      const date = new Date(dateStr)
      const now = new Date()
      const diffMs = now - date
      const diffMins = Math.floor(diffMs / 60000)
      const diffHours = Math.floor(diffMs / 3600000)

      if (diffMins < 1) return 'just now'
      if (diffMins < 60) return `${diffMins} min ago`
      if (diffHours < 24) return `${diffHours} hr ago`
      return date.toLocaleDateString()
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return ''
      const date = new Date(dateStr)
      return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
    }

    function formatStatus(status) {
      const statusMap = {
        'connected': 'Connected', 'completed': 'Connected', 'in_progress': 'In Progress',
        'missed': 'Missed', 'no-answer': 'No Answer', 'no_answer': 'No Answer'
      }
      return statusMap[status] || status
    }

    function formatOutcome(outcome) {
      const outcomeMap = {
        'booked': 'Booked', 'estimate': 'Estimate', 'question': 'Question',
        'current_customer': 'Current Customer', 'not_interested': 'Not Interested'
      }
      return outcomeMap[outcome] || outcome
    }

    function getOutcomeBadgeClass(outcome) {
      const classMap = {
        'booked': 'success', 'estimate': 'info', 'question': 'info',
        'current_customer': 'info', 'not_interested': 'secondary'
      }
      return classMap[outcome] || 'secondary'
    }

    // ===========================================
    // DECLINED/MISSED CALL RECORDING
    // ===========================================

    async function findOrCreateContact(phoneNumber) {
      if (!phoneNumber || !companyId) return null

      try {
        const cleanedPhone = phoneNumber.replace(/\D/g, '')

        const { data: existingContact } = await supabase
          .from('contacts')
          .select('id, first_name, last_name')
          .eq('company_id', companyId)
          .or(`phone.eq.${phoneNumber},phone.eq.${cleanedPhone},phone.eq.+1${cleanedPhone}`)
          .limit(1)
          .single()

        if (existingContact) return existingContact

        const { data: newContact, error } = await supabase
          .from('contacts')
          .insert({
            company_id: companyId,
            phone: phoneNumber,
            first_name: 'Unknown',
            last_name: 'Caller',
            source: 'inbound_call'
          })
          .select('id, first_name, last_name')
          .single()

        if (error) {
          console.error('Error creating contact:', error)
          return null
        }

        return newContact
      } catch (error) {
        console.error('findOrCreateContact error:', error)
        return null
      }
    }

    async function createDeclinedCallRecord(phoneNumber) {
      console.log('createDeclinedCallRecord: Logging declined call from:', phoneNumber)

      if (!companyId) {
        console.error('Cannot create declined call record: missing company ID')
        return
      }

      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        console.error('Cannot create declined call record: no authenticated user')
        return
      }

      try {
        const contact = await findOrCreateContact(phoneNumber)
        const contactId = contact?.id || null

        const insertData = {
          company_id: companyId,
          rep_id: user.id,
          contact_id: contactId,
          phone_number: phoneNumber,
          direction: 'inbound',
          status: 'missed',
          outcome: null,
          started_at: new Date().toISOString(),
          ended_at: new Date().toISOString(),
          duration_seconds: 0
        }

        const { data, error } = await supabase
          .from('calls')
          .insert(insertData)
          .select('id')
          .single()

        if (error) {
          console.error('createDeclinedCallRecord: Failed:', error)
        } else {
          console.log('createDeclinedCallRecord: SUCCESS:', data.id)
          await loadCalls()
        }
      } catch (error) {
        console.error('createDeclinedCallRecord: Exception:', error)
      }
    }
    window.createDeclinedCallRecord = createDeclinedCallRecord

    // ===========================================
    // SIDEBAR FUNCTIONS
    // ===========================================

    let sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

    function initSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (sidebarCollapsed && window.innerWidth > 1024) {
        sidebar.classList.add('collapsed');
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebarCollapsed = !sidebarCollapsed;
      sidebar.classList.toggle('collapsed', sidebarCollapsed);
      localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
    }

    function openSidebar() {
      document.getElementById('sidebar').classList.add('mobile-open');
      document.getElementById('sidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('mobile-open');
      document.getElementById('sidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    initSidebar();

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('active');
      });
    });

    // Escape key to close modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        if (pendingIncomingCall) declineIncomingCall();
      }
    });

    // ===========================================
    // INCOMING CALL HANDLING
    // ===========================================

    function playRingtone() {
      if (ringtoneAudio) return;
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 440;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.3;
        oscillator.start();
        let ringOn = true;
        const ringInterval = setInterval(() => { gainNode.gain.value = ringOn ? 0.3 : 0; ringOn = !ringOn; }, 500);
        ringtoneAudio = { oscillator, gainNode, audioContext, ringInterval };
      } catch (e) { console.error('Error playing ringtone:', e); }
    }

    function stopRingtone() {
      if (ringtoneAudio) {
        try { clearInterval(ringtoneAudio.ringInterval); ringtoneAudio.oscillator.stop(); ringtoneAudio.audioContext.close(); } catch (e) {}
        ringtoneAudio = null;
      }
    }

    function showIncomingCallModal(from) {
      const modal = document.getElementById('incomingCallModal');
      const callerDisplay = document.getElementById('incomingCallNumber');
      if (modal && callerDisplay) { callerDisplay.textContent = from || 'Unknown Caller'; modal.classList.add('active'); playRingtone(); }
    }

    function hideIncomingCallModal() { document.getElementById('incomingCallModal').classList.remove('active'); stopRingtone(); }

    function answerIncomingCall() {
      if (pendingIncomingCall) {
        console.log('Answering incoming call...');
        pendingIncomingCall.accept();
        hideIncomingCallModal();
        showActiveCallIndicator();
      }
    }

    function showActiveCallIndicator() {
      let indicator = document.getElementById('activeCallIndicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'activeCallIndicator';
        indicator.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;z-index:10001;display:flex;align-items:center;gap:10px;box-shadow:0 4px 12px rgba(0,0,0,0.2);';
        indicator.innerHTML = '<span style="width:10px;height:10px;background:white;border-radius:50%;animation:pulse 1s infinite;"></span> Call Active <button onclick="endActiveCall()" style="margin-left:10px;background:#ef4444;border:none;color:white;padding:6px 12px;border-radius:4px;cursor:pointer;">End Call</button>';
        document.body.appendChild(indicator);
      }
      indicator.style.display = 'flex';
    }

    function endActiveCall() {
      if (pendingIncomingCall) { pendingIncomingCall.disconnect(); pendingIncomingCall = null; }
      const indicator = document.getElementById('activeCallIndicator');
      if (indicator) indicator.style.display = 'none';
    }

    function declineIncomingCall() {
      if (pendingIncomingCall) {
        const callerNumber = pendingIncomingCall.parameters?.From || null;
        pendingIncomingCall.reject();
        pendingIncomingCall = null;
        hideIncomingCallModal();
        if (callerNumber) createDeclinedCallRecord(callerNumber);
      }
    }

    function handleIncomingCall(call) {
      console.log('Incoming call received on newsfeed:', call.parameters.From);
      pendingIncomingCall = call;
      call.on('cancel', () => {
        const callerNumber = call.parameters?.From || null;
        hideIncomingCallModal();
        endActiveCall();
        if (callerNumber) createDeclinedCallRecord(callerNumber);
      });
      call.on('disconnect', () => { hideIncomingCallModal(); endActiveCall(); });
      showIncomingCallModal(call.parameters.From);
    }

    async function initTwilioDevice() {
      try {
        console.log('Initializing Twilio device for incoming calls...');
        const response = await fetch(`/token?identity=${repIdentity}`);
        const data = await response.json();
        if (!data.token) { console.error('No token received'); return; }
        twilioDevice = new Twilio.Device(data.token, { codecPreferences: ['opus', 'pcmu'], logLevel: 1 });
        twilioDevice.on('registered', () => { console.log('Twilio Device registered for incoming calls (newsfeed page)'); });
        twilioDevice.on('error', (error) => { console.error('Twilio Device error:', error.message || error); });
        twilioDevice.on('incoming', handleIncomingCall);
        await twilioDevice.register();
        console.log('Twilio Device registration complete on newsfeed page');
      } catch (error) { console.error('Error initializing Twilio Device:', error); }
    }

    document.getElementById('answerCallBtn')?.addEventListener('click', answerIncomingCall);
    document.getElementById('declineCallBtn')?.addEventListener('click', declineIncomingCall);
  </script>

  <!-- ISSUE-211 FIX: Removed duplicate incoming call modal (was duplicated at end of file) -->
  <!-- Single modal kept earlier in the file at line ~620 -->
</body>
</html>
