<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Contact Profile - DialPro</title>
  <link rel="stylesheet" href="css/styles.css">
  <!-- Supabase JS SDK (local) -->
  <script src="js/supabase.min.js"></script>
  <script src="js/supabase-config.js"></script>
  <style>
    /* Profile Page Layout */
    .profile-layout {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: var(--spacing-lg);
      height: 100%;
    }

    /* Left Column - Contact Info */
    .profile-sidebar {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    /* Profile Card */
    .profile-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .profile-header {
      background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
      padding: var(--spacing-xl) var(--spacing-lg);
      text-align: center;
      color: white;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 600;
      margin: 0 auto var(--spacing-md);
      border: 4px solid rgba(255,255,255,0.3);
    }

    .profile-name {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .profile-company {
      opacity: 0.9;
      font-size: 1rem;
    }

    .profile-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-full);
      font-size: 0.875rem;
      margin-top: var(--spacing-md);
    }

    .profile-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }

    .profile-status.qualified .dot { background: #10b981; }
    .profile-status.new .dot { background: #3b82f6; }
    .profile-status.contacted .dot { background: #f59e0b; }
    .profile-status.lost .dot { background: #ef4444; }

    .profile-actions {
      display: flex;
      gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--gray-100);
    }

    .profile-actions .btn {
      flex: 1;
    }

    .profile-details {
      padding: var(--spacing-lg);
    }

    .profile-detail-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      padding: var(--spacing-sm) 0;
    }

    .profile-detail-item:not(:last-child) {
      border-bottom: 1px solid var(--gray-100);
    }

    .profile-detail-icon {
      width: 36px;
      height: 36px;
      background: var(--gray-100);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .profile-detail-content {
      flex: 1;
      min-width: 0;
    }

    .profile-detail-label {
      font-size: 0.75rem;
      color: var(--gray-500);
      text-transform: uppercase;
      font-weight: 600;
    }

    .profile-detail-value {
      color: var(--gray-800);
      word-break: break-word;
    }

    .profile-detail-value a {
      color: var(--primary);
      text-decoration: none;
    }

    .profile-detail-value a:hover {
      text-decoration: underline;
    }

    /* Tags */
    .profile-tags {
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid var(--gray-100);
    }

    .profile-tags-title {
      font-size: 0.75rem;
      color: var(--gray-500);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--gray-100);
      color: var(--gray-700);
      border-radius: var(--radius-full);
      font-size: 0.8125rem;
    }

    .tag.hot { background: var(--danger-light); color: var(--danger); }
    .tag.vip { background: #fef3c7; color: #d97706; }
    .tag.referral { background: #f3e5f5; color: #9c27b0; }

    .add-tag-btn {
      padding: 4px 10px;
      background: none;
      border: 1px dashed var(--gray-300);
      border-radius: var(--radius-full);
      color: var(--gray-500);
      font-size: 0.8125rem;
      cursor: pointer;
    }

    .add-tag-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Quick Stats */
    .quick-stats {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: var(--spacing-md);
    }

    .quick-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }

    .quick-stat {
      text-align: center;
      padding: var(--spacing-sm);
      background: var(--gray-50);
      border-radius: var(--radius-md);
    }

    .quick-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-800);
    }

    .quick-stat-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .quick-stat.success .quick-stat-value { color: var(--success); }
    .quick-stat.warning .quick-stat-value { color: var(--warning); }
    .quick-stat.primary .quick-stat-value { color: var(--primary); }

    /* Right Column - Activity & Details */
    .profile-main {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
      overflow-y: auto;
    }

    /* Tabs */
    .profile-tabs {
      display: flex;
      gap: 4px;
      background: white;
      padding: var(--spacing-sm);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .profile-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-radius: var(--radius-md);
      color: var(--gray-500);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .profile-tab:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .profile-tab.active {
      background: var(--primary);
      color: white;
    }

    .profile-tab .badge {
      padding: 2px 8px;
      background: rgba(0,0,0,0.1);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }

    .profile-tab.active .badge {
      background: rgba(255,255,255,0.2);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Activity Timeline */
    .activity-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .activity-header {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .activity-header h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--gray-800);
    }

    .activity-filters {
      display: flex;
      gap: var(--spacing-sm);
    }

    .activity-filter {
      padding: 4px 12px;
      background: var(--gray-100);
      border: none;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      color: var(--gray-600);
      cursor: pointer;
    }

    .activity-filter.active {
      background: var(--primary-light);
      color: var(--primary);
    }

    .activity-timeline {
      padding: var(--spacing-lg);
    }

    .timeline-item {
      display: flex;
      gap: var(--spacing-md);
      position: relative;
      padding-bottom: var(--spacing-lg);
    }

    .timeline-item:not(:last-child)::before {
      content: '';
      position: absolute;
      left: 18px;
      top: 40px;
      bottom: 0;
      width: 2px;
      background: var(--gray-200);
    }

    .timeline-icon {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
      z-index: 1;
    }

    .timeline-icon.call { background: var(--success-light); color: var(--success); }
    .timeline-icon.missed { background: var(--danger-light); color: var(--danger); }
    .timeline-icon.note { background: var(--warning-light); color: var(--warning); }
    .timeline-icon.email { background: var(--primary-light); color: var(--primary); }
    .timeline-icon.stage { background: #f3e5f5; color: #9c27b0; }
    .timeline-icon.created { background: var(--gray-100); color: var(--gray-600); }

    .timeline-content {
      flex: 1;
      min-width: 0;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }

    .timeline-title {
      font-weight: 600;
      color: var(--gray-800);
    }

    .timeline-time {
      font-size: 0.75rem;
      color: var(--gray-400);
      white-space: nowrap;
    }

    .timeline-description {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin-bottom: var(--spacing-sm);
    }

    .timeline-details {
      background: var(--gray-50);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 0.8125rem;
    }

    .timeline-details-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }

    .timeline-details-row:not(:last-child) {
      border-bottom: 1px solid var(--gray-200);
    }

    .timeline-details-label {
      color: var(--gray-500);
    }

    .timeline-details-value {
      color: var(--gray-700);
      font-weight: 500;
    }

    .timeline-actions {
      display: flex;
      gap: var(--spacing-xs);
      margin-top: var(--spacing-sm);
    }

    /* Call History Card */
    .call-history-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .call-history-item:hover {
      background: var(--gray-50);
    }

    .call-history-item:last-child {
      border-bottom: none;
    }

    .call-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
    }

    .call-icon.connected { background: var(--success-light); color: var(--success); }
    .call-icon.missed { background: var(--danger-light); color: var(--danger); }
    .call-icon.voicemail { background: var(--warning-light); color: var(--warning); }
    .call-icon.outbound { background: var(--primary-light); color: var(--primary); }

    .call-info {
      flex: 1;
    }

    .call-title {
      font-weight: 500;
      color: var(--gray-800);
    }

    .call-meta {
      font-size: 0.8125rem;
      color: var(--gray-500);
      display: flex;
      gap: var(--spacing-sm);
    }

    .call-actions {
      display: flex;
      gap: var(--spacing-xs);
    }

    /* Notes Section */
    .notes-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .notes-header {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notes-header h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--gray-800);
    }

    .add-note-form {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--gray-100);
      background: var(--gray-50);
    }

    .add-note-form textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      margin-bottom: var(--spacing-sm);
    }

    .add-note-form .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
    }

    .add-note-form .btn-secondary.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .note-item {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--gray-100);
    }

    .note-item:last-child {
      border-bottom: none;
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .note-author {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .note-author-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--primary-light);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .note-author-name {
      font-weight: 500;
      color: var(--gray-800);
    }

    .note-time {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    .note-content {
      color: var(--gray-600);
      font-size: 0.9375rem;
      line-height: 1.6;
    }

    .note-content.pinned {
      background: #fef3c7;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      border-left: 3px solid #f59e0b;
    }

    .note-actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .note-action-btn {
      padding: 4px 8px;
      background: none;
      border: none;
      color: var(--gray-400);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .note-action-btn:hover {
      color: var(--gray-600);
    }

    /* Pipeline Stage Tracker */
    .stage-tracker {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: var(--spacing-lg);
    }

    .stage-tracker-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: var(--spacing-md);
    }

    .stage-progress {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stage-step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .stage-step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gray-200);
      color: var(--gray-400);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      margin: 0 auto var(--spacing-xs);
      transition: all 0.2s ease;
    }

    .stage-step.completed .stage-step-dot {
      background: var(--success);
      color: white;
    }

    .stage-step.current .stage-step-dot {
      background: var(--primary);
      color: white;
      box-shadow: 0 0 0 4px var(--primary-light);
    }

    .stage-step-label {
      font-size: 0.6875rem;
      color: var(--gray-500);
      white-space: nowrap;
    }

    .stage-step.completed .stage-step-label,
    .stage-step.current .stage-step-label {
      color: var(--gray-700);
      font-weight: 500;
    }

    .stage-connector {
      width: 100%;
      height: 3px;
      background: var(--gray-200);
      flex-shrink: 1;
      margin-top: -20px;
    }

    .stage-connector.completed {
      background: var(--success);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .profile-layout {
        grid-template-columns: 1fr;
      }

      .profile-sidebar {
        order: -1;
      }
    }

    @media (max-width: 768px) {
      .profile-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .profile-tab {
        white-space: nowrap;
      }

      .quick-stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .activity-filters {
        display: none;
      }
    }

    /* Sidebar toggle - ensure visibility */
    .sidebar-toggle {
      display: flex !important;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="sidebar-logo">
          <div class="sidebar-logo-icon">AI</div>
          <span class="sidebar-logo-text">DialPro</span>
        </a>
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
          <span>‚óÄ</span>
        </button>
      </div>

      <nav class="sidebar-nav">
        <!-- Main Section -->
        <div class="sidebar-nav-section">
          <a href="dashboard.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìä</span>
            <span class="sidebar-nav-label">Dashboard</span>
          </a>
          <a href="newsfeed.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üì∞</span>
            <span class="sidebar-nav-label">Newsfeed</span>
          </a>
          <a href="activity.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">‚ö°</span>
            <span class="sidebar-nav-label">Activity</span>
          </a>
        </div>

        <!-- Contacts Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">Contacts</div>
          <a href="contacts.html" class="sidebar-nav-item active">
            <span class="sidebar-nav-icon">üë•</span>
            <span class="sidebar-nav-label">All Contacts</span>
          </a>
          <a href="contacts-import.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üì•</span>
            <span class="sidebar-nav-label">Import</span>
          </a>
        </div>

        <!-- Communication Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">Communication</div>
          <a href="sms.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üí¨</span>
            <span class="sidebar-nav-label">SMS</span>
            <span class="sidebar-nav-badge">3</span>
          </a>
          <a href="call.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìû</span>
            <span class="sidebar-nav-label">Make Call</span>
          </a>
          <a href="history.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìã</span>
            <span class="sidebar-nav-label">History</span>
          </a>
          <a href="callbacks.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üîî</span>
            <span class="sidebar-nav-label">Callbacks</span>
            <span class="sidebar-nav-badge" id="callbackBadge">0</span>
          </a>
        </div>

        <!-- Sales Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">Sales</div>
          <a href="pipeline.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìà</span>
            <span class="sidebar-nav-label">Pipeline</span>
          </a>
        </div>

        <!-- Team Section -->
        <div class="sidebar-nav-section">
          <div class="sidebar-nav-section-title">Team</div>
          <a href="supervisor.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üëÅÔ∏è</span>
            <span class="sidebar-nav-label">Supervisor</span>
          </a>
          <a href="supervisor-mockup.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">üìä</span>
            <span class="sidebar-nav-label">Team Overview</span>
          </a>
        </div>

        <!-- Settings -->
        <div class="sidebar-nav-section" style="margin-top: auto;">
          <a href="settings.html" class="sidebar-nav-item">
            <span class="sidebar-nav-icon">‚öôÔ∏è</span>
            <span class="sidebar-nav-label">Settings</span>
          </a>
        </div>
      </nav>

      <!-- User Section -->
      <div class="sidebar-user">
        <div class="sidebar-user-avatar" id="userAvatar">SR</div>
        <div class="sidebar-user-info">
          <div class="sidebar-user-name" id="userName">Sales Rep</div>
          <div class="sidebar-user-status" id="userStatus">
            <span class="status-dot"></span>
            <span id="connectionText">Online</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
      <!-- Top Header -->
      <header class="top-header">
        <div class="top-header-left">
          <button class="mobile-menu-btn" onclick="openSidebar()">‚ò∞</button>
          <a href="contacts.html" style="color: var(--gray-400); text-decoration: none; margin-right: var(--spacing-sm);">‚Üê Back</a>
          <h1 class="page-title">Contact Profile</h1>
        </div>
        <div class="top-header-right">
          <button class="header-action-btn" title="Edit Contact" onclick="editContact()">‚úèÔ∏è</button>
          <button class="header-action-btn" title="More Options" onclick="showMoreOptions()">‚ãÆ</button>
        </div>
      </header>

      <!-- Main Content Area -->
      <main class="main-content-area">
        <div class="profile-layout">
          <!-- Left Sidebar - Contact Info -->
          <div class="profile-sidebar">
            <!-- Profile Card -->
            <div class="profile-card">
              <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">JD</div>
                <div class="profile-name" id="profileName">John Doe</div>
                <div class="profile-company" id="profileCompany">Acme Corporation</div>
                <div class="profile-status qualified" id="profileStatus">
                  <span class="dot"></span>
                  Qualified Lead
                </div>
              </div>

              <div class="profile-actions">
                <button class="btn btn-success" onclick="callContact()">üìû Call</button>
                <button class="btn btn-primary" onclick="addToQueue()">+ Queue</button>
                <button class="btn btn-secondary" onclick="sendEmail()">‚úâÔ∏è</button>
              </div>

              <div class="profile-details">
                <div class="profile-detail-item">
                  <div class="profile-detail-icon">üì±</div>
                  <div class="profile-detail-content">
                    <div class="profile-detail-label">Phone</div>
                    <div class="profile-detail-value">
                      <a href="tel:+15551234567">+1 (555) 123-4567</a>
                    </div>
                  </div>
                </div>
                <div class="profile-detail-item">
                  <div class="profile-detail-icon">‚úâÔ∏è</div>
                  <div class="profile-detail-content">
                    <div class="profile-detail-label">Email</div>
                    <div class="profile-detail-value">
                      <a href="mailto:john.doe@acmecorp.com">john.doe@acmecorp.com</a>
                    </div>
                  </div>
                </div>
                <div class="profile-detail-item">
                  <div class="profile-detail-icon">üè¢</div>
                  <div class="profile-detail-content">
                    <div class="profile-detail-label">Company</div>
                    <div class="profile-detail-value">Acme Corporation</div>
                  </div>
                </div>
                <div class="profile-detail-item">
                  <div class="profile-detail-icon">üíº</div>
                  <div class="profile-detail-content">
                    <div class="profile-detail-label">Title</div>
                    <div class="profile-detail-value">VP of Operations</div>
                  </div>
                </div>
                <div class="profile-detail-item">
                  <div class="profile-detail-icon">üåê</div>
                  <div class="profile-detail-content">
                    <div class="profile-detail-label">Source</div>
                    <div class="profile-detail-value">Facebook Lead Ad</div>
                  </div>
                </div>
                <div class="profile-detail-item">
                  <div class="profile-detail-icon">üìÖ</div>
                  <div class="profile-detail-content">
                    <div class="profile-detail-label">Added</div>
                    <div class="profile-detail-value">January 10, 2025</div>
                  </div>
                </div>
                <div class="profile-detail-item">
                  <div class="profile-detail-icon">üë§</div>
                  <div class="profile-detail-content">
                    <div class="profile-detail-label">Assigned To</div>
                    <div class="profile-detail-value">Sarah Mitchell</div>
                  </div>
                </div>
              </div>

              <div class="profile-tags">
                <div class="profile-tags-title">Tags</div>
                <div class="tags-list">
                  <span class="tag hot">üî• Hot Lead</span>
                  <span class="tag vip">‚≠ê VIP</span>
                  <span class="tag">Enterprise</span>
                  <span class="tag referral">Referral</span>
                  <button class="add-tag-btn" onclick="addTag()">+ Add Tag</button>
                </div>
              </div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
              <div class="quick-stats-grid">
                <div class="quick-stat primary">
                  <div class="quick-stat-value">12</div>
                  <div class="quick-stat-label">Total Calls</div>
                </div>
                <div class="quick-stat success">
                  <div class="quick-stat-value">8</div>
                  <div class="quick-stat-label">Connected</div>
                </div>
                <div class="quick-stat warning">
                  <div class="quick-stat-value">45m</div>
                  <div class="quick-stat-label">Talk Time</div>
                </div>
                <div class="quick-stat">
                  <div class="quick-stat-value">$15K</div>
                  <div class="quick-stat-label">Deal Value</div>
                </div>
              </div>
            </div>

            <!-- Pipeline Stage -->
            <div class="stage-tracker">
              <div class="stage-tracker-title">Pipeline Stage</div>
              <div class="stage-progress">
                <div class="stage-step completed">
                  <div class="stage-step-dot">‚úì</div>
                  <div class="stage-step-label">New</div>
                </div>
                <div class="stage-connector completed"></div>
                <div class="stage-step completed">
                  <div class="stage-step-dot">‚úì</div>
                  <div class="stage-step-label">Contacted</div>
                </div>
                <div class="stage-connector completed"></div>
                <div class="stage-step current">
                  <div class="stage-step-dot">3</div>
                  <div class="stage-step-label">Qualified</div>
                </div>
                <div class="stage-connector"></div>
                <div class="stage-step">
                  <div class="stage-step-dot">4</div>
                  <div class="stage-step-label">Proposal</div>
                </div>
                <div class="stage-connector"></div>
                <div class="stage-step">
                  <div class="stage-step-dot">5</div>
                  <div class="stage-step-label">Won</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Main - Activity & Notes -->
          <div class="profile-main">
            <!-- Tabs -->
            <div class="profile-tabs">
              <button class="profile-tab active" data-tab="activity" onclick="switchTab('activity')">
                üìã Activity
              </button>
              <button class="profile-tab" data-tab="calls" onclick="switchTab('calls')">
                üìû Calls <span class="badge">12</span>
              </button>
              <button class="profile-tab" data-tab="notes" onclick="switchTab('notes')">
                üìù Notes <span class="badge">5</span>
              </button>
              <button class="profile-tab" data-tab="emails" onclick="switchTab('emails')">
                ‚úâÔ∏è Emails <span class="badge">3</span>
              </button>
              <button class="profile-tab" data-tab="files" onclick="switchTab('files')">
                üìé Files
              </button>
            </div>

            <!-- Activity Tab -->
            <div class="tab-content active" id="activityTab">
              <div class="activity-card">
                <div class="activity-header">
                  <h3>Activity Timeline</h3>
                  <div class="activity-filters">
                    <button class="activity-filter active">All</button>
                    <button class="activity-filter">Calls</button>
                    <button class="activity-filter">Notes</button>
                    <button class="activity-filter">Emails</button>
                  </div>
                </div>
                <div class="activity-timeline">
                  <!-- Today -->
                  <div class="timeline-item">
                    <div class="timeline-icon call">üìû</div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-title">Outbound Call - Connected</span>
                        <span class="timeline-time">2 hours ago</span>
                      </div>
                      <div class="timeline-description">
                        Discussed pricing options and product features. Client is interested in the Enterprise plan.
                      </div>
                      <div class="timeline-details">
                        <div class="timeline-details-row">
                          <span class="timeline-details-label">Duration</span>
                          <span class="timeline-details-value">12:34</span>
                        </div>
                        <div class="timeline-details-row">
                          <span class="timeline-details-label">Outcome</span>
                          <span class="timeline-details-value">Follow-up scheduled</span>
                        </div>
                      </div>
                      <div class="timeline-actions">
                        <button class="btn btn-sm btn-secondary">üéß Listen</button>
                        <button class="btn btn-sm btn-secondary">üìÑ Transcript</button>
                      </div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-icon note">üìù</div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-title">Note Added</span>
                        <span class="timeline-time">3 hours ago</span>
                      </div>
                      <div class="timeline-description">
                        Client mentioned they are comparing with 2 other vendors. Decision expected by end of month. Key decision maker is the CFO.
                      </div>
                    </div>
                  </div>

                  <!-- Yesterday -->
                  <div class="timeline-item">
                    <div class="timeline-icon stage">üéØ</div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-title">Stage Changed: Contacted ‚Üí Qualified</span>
                        <span class="timeline-time">Yesterday</span>
                      </div>
                      <div class="timeline-description">
                        Lead qualified based on budget confirmation and timeline alignment.
                      </div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-icon call">üìû</div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-title">Outbound Call - Connected</span>
                        <span class="timeline-time">Yesterday</span>
                      </div>
                      <div class="timeline-description">
                        Initial discovery call. Identified pain points around current solution.
                      </div>
                      <div class="timeline-details">
                        <div class="timeline-details-row">
                          <span class="timeline-details-label">Duration</span>
                          <span class="timeline-details-value">8:45</span>
                        </div>
                      </div>
                      <div class="timeline-actions">
                        <button class="btn btn-sm btn-secondary">üéß Listen</button>
                        <button class="btn btn-sm btn-secondary">üìÑ Transcript</button>
                      </div>
                    </div>
                  </div>

                  <!-- Last Week -->
                  <div class="timeline-item">
                    <div class="timeline-icon missed">üìµ</div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-title">Outbound Call - No Answer</span>
                        <span class="timeline-time">Jan 12, 2025</span>
                      </div>
                      <div class="timeline-description">
                        Left voicemail requesting callback.
                      </div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-icon email">‚úâÔ∏è</div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-title">Email Sent: Introduction</span>
                        <span class="timeline-time">Jan 11, 2025</span>
                      </div>
                      <div class="timeline-description">
                        Sent introductory email with product brochure attached.
                      </div>
                      <div class="timeline-actions">
                        <button class="btn btn-sm btn-secondary">üëÅÔ∏è View Email</button>
                      </div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-icon created">‚ûï</div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-title">Contact Created</span>
                        <span class="timeline-time">Jan 10, 2025</span>
                      </div>
                      <div class="timeline-description">
                        Lead imported from Facebook Lead Ad campaign "Q1 Enterprise Push"
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Calls Tab -->
            <div class="tab-content" id="callsTab">
              <div class="activity-card">
                <div class="activity-header">
                  <h3>Call History</h3>
                  <button class="btn btn-sm btn-primary" onclick="callContact()">üìû New Call</button>
                </div>
                <div>
                  <div class="call-history-item" onclick="viewCallDetails(1)">
                    <div class="call-icon connected">üìû</div>
                    <div class="call-info">
                      <div class="call-title">Outbound Call - Connected</div>
                      <div class="call-meta">
                        <span>12:34 duration</span>
                        <span>‚Ä¢</span>
                        <span>2 hours ago</span>
                      </div>
                    </div>
                    <div class="call-actions">
                      <button class="btn btn-sm btn-secondary">üéß</button>
                      <button class="btn btn-sm btn-secondary">üìÑ</button>
                    </div>
                  </div>
                  <div class="call-history-item" onclick="viewCallDetails(2)">
                    <div class="call-icon connected">üìû</div>
                    <div class="call-info">
                      <div class="call-title">Outbound Call - Connected</div>
                      <div class="call-meta">
                        <span>8:45 duration</span>
                        <span>‚Ä¢</span>
                        <span>Yesterday</span>
                      </div>
                    </div>
                    <div class="call-actions">
                      <button class="btn btn-sm btn-secondary">üéß</button>
                      <button class="btn btn-sm btn-secondary">üìÑ</button>
                    </div>
                  </div>
                  <div class="call-history-item" onclick="viewCallDetails(3)">
                    <div class="call-icon missed">üìµ</div>
                    <div class="call-info">
                      <div class="call-title">Outbound Call - No Answer</div>
                      <div class="call-meta">
                        <span>Voicemail left</span>
                        <span>‚Ä¢</span>
                        <span>Jan 12, 2025</span>
                      </div>
                    </div>
                    <div class="call-actions">
                      <button class="btn btn-sm btn-secondary">üéß</button>
                    </div>
                  </div>
                  <div class="call-history-item" onclick="viewCallDetails(4)">
                    <div class="call-icon missed">üìµ</div>
                    <div class="call-info">
                      <div class="call-title">Outbound Call - No Answer</div>
                      <div class="call-meta">
                        <span>No voicemail</span>
                        <span>‚Ä¢</span>
                        <span>Jan 11, 2025</span>
                      </div>
                    </div>
                    <div class="call-actions">
                      <button class="btn btn-sm btn-secondary">üîÅ Retry</button>
                    </div>
                  </div>
                  <div class="call-history-item" onclick="viewCallDetails(5)">
                    <div class="call-icon connected">üìû</div>
                    <div class="call-info">
                      <div class="call-title">Outbound Call - Connected</div>
                      <div class="call-meta">
                        <span>3:22 duration</span>
                        <span>‚Ä¢</span>
                        <span>Jan 10, 2025</span>
                      </div>
                    </div>
                    <div class="call-actions">
                      <button class="btn btn-sm btn-secondary">üéß</button>
                      <button class="btn btn-sm btn-secondary">üìÑ</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notes Tab (ISSUE-307 FIX: Removed static demo data, show loading initially) -->
            <div class="tab-content" id="notesTab">
              <div class="notes-card">
                <div class="notes-header">
                  <h3>Notes</h3>
                </div>
                <div class="add-note-form">
                  <textarea class="input" id="newNoteContent" placeholder="Add a note about this contact..."></textarea>
                  <div class="form-actions">
                    <button class="btn btn-secondary btn-sm" id="pinNoteBtn" onclick="togglePinNote()">üìå Pin</button>
                    <button class="btn btn-primary btn-sm" id="addNoteBtn" onclick="handleAddNote()">Add Note</button>
                  </div>
                </div>
                <!-- Notes loaded dynamically - ISSUE-307 FIX -->
                <div id="notesContainer">
                  <div class="note-item">
                    <div style="text-align: center; padding: 20px; color: var(--gray-500);">
                      Loading notes...
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Emails Tab -->
            <div class="tab-content" id="emailsTab">
              <div class="activity-card">
                <div class="activity-header">
                  <h3>Email History</h3>
                  <button class="btn btn-sm btn-primary" onclick="composeEmail()">‚úâÔ∏è New Email</button>
                </div>
                <div>
                  <div class="call-history-item" onclick="viewEmail(1)">
                    <div class="call-icon outbound">üì§</div>
                    <div class="call-info">
                      <div class="call-title">Re: Follow-up on our conversation</div>
                      <div class="call-meta">
                        <span>Sent</span>
                        <span>‚Ä¢</span>
                        <span>2 hours ago</span>
                      </div>
                    </div>
                    <div class="call-actions">
                      <button class="btn btn-sm btn-secondary">üëÅÔ∏è</button>
                    </div>
                  </div>
                  <div class="call-history-item" onclick="viewEmail(2)">
                    <div class="call-icon connected">üì•</div>
                    <div class="call-info">
                      <div class="call-title">Re: Introduction - AI Sales Coach</div>
                      <div class="call-meta">
                        <span>Received</span>
                        <span>‚Ä¢</span>
                        <span>Yesterday</span>
                      </div>
                    </div>
                    <div class="call-actions">
                      <button class="btn btn-sm btn-secondary">üëÅÔ∏è</button>
                      <button class="btn btn-sm btn-secondary">‚Ü©Ô∏è</button>
                    </div>
                  </div>
                  <div class="call-history-item" onclick="viewEmail(3)">
                    <div class="call-icon outbound">üì§</div>
                    <div class="call-info">
                      <div class="call-title">Introduction - AI Sales Coach</div>
                      <div class="call-meta">
                        <span>Sent ‚Ä¢ Opened</span>
                        <span>‚Ä¢</span>
                        <span>Jan 11, 2025</span>
                      </div>
                    </div>
                    <div class="call-actions">
                      <button class="btn btn-sm btn-secondary">üëÅÔ∏è</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Files Tab -->
            <div class="tab-content" id="filesTab">
              <div class="activity-card">
                <div class="activity-header">
                  <h3>Files & Attachments</h3>
                  <button class="btn btn-sm btn-primary" onclick="uploadFile()">üìé Upload</button>
                </div>
                <div style="padding: var(--spacing-lg);">
                  <div class="empty-state">
                    <div class="empty-state-icon">üìÅ</div>
                    <div class="empty-state-title">No files yet</div>
                    <div class="empty-state-text">Upload contracts, proposals, or other documents</div>
                    <button class="btn btn-primary" onclick="uploadFile()">üìé Upload File</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Mobile Bottom Nav -->
    <nav class="mobile-bottom-nav">
      <div class="mobile-nav-items">
        <a href="dashboard.html" class="mobile-nav-item">
          <span class="mobile-nav-icon">üìä</span>
          <span>Dashboard</span>
        </a>
        <a href="contacts.html" class="mobile-nav-item active">
          <span class="mobile-nav-icon">üë•</span>
          <span>Contacts</span>
        </a>
        <a href="history.html" class="mobile-nav-item">
          <span class="mobile-nav-icon">üìã</span>
          <span>History</span>
        </a>
        <a href="pipeline.html" class="mobile-nav-item">
          <span class="mobile-nav-icon">üìà</span>
          <span>Pipeline</span>
        </a>
      </div>
    </nav>

    <!-- Call FAB (mobile) -->
    <button class="call-fab" onclick="callContact()">üìû</button>
  </div>

  <!-- Additional Styles for Edit Modal and Toast -->
  <style>
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: var(--radius-md);
      color: white;
      font-size: 0.875rem;
      z-index: 10001;
      animation: toast-in 0.3s ease;
      box-shadow: var(--shadow-lg);
    }
    .toast-info { background: var(--gray-800); }
    .toast-success { background: var(--success); }
    .toast-error { background: var(--danger); }
    .toast-warning { background: var(--warning); }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .btn.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }
    .btn.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Edit Contact Modal */
    .modal-form .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 576px) {
      .modal-form .form-row {
        grid-template-columns: 1fr;
      }
    }
    /* Edit Note Modal */
    #editNoteModal .modal-body textarea {
      min-height: 120px;
    }
  </style>

  <!-- Edit Contact Modal (ISSUE-304 FIX) -->
  <div class="modal-overlay" id="editContactModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Edit Contact</h3>
        <button class="modal-close" onclick="closeEditContactModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="editContactForm" class="modal-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">First Name *</label>
              <input type="text" name="firstName" id="editFirstName" class="input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Last Name *</label>
              <input type="text" name="lastName" id="editLastName" class="input" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Phone *</label>
            <input type="tel" name="phone" id="editPhone" class="input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" name="email" id="editEmail" class="input">
          </div>
          <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" name="company" id="editCompany" class="input">
          </div>
          <div class="form-group">
            <label class="form-label">Job Title</label>
            <input type="text" name="title" id="editTitle" class="input">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select name="status" id="editStatus" class="input">
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="qualified">Qualified</option>
              <option value="proposal">Proposal</option>
              <option value="won">Won</option>
              <option value="lost">Lost</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditContactModal()">Cancel</button>
        <button class="btn btn-primary" id="saveEditContactBtn" onclick="saveEditContact()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Edit Note Modal (ISSUE-306 FIX) -->
  <div class="modal-overlay" id="editNoteModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Edit Note</h3>
        <button class="modal-close" onclick="closeEditNoteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Note Content</label>
          <textarea id="editNoteContent" class="input" rows="5" placeholder="Enter note content..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditNoteModal()">Cancel</button>
        <button class="btn btn-primary" id="saveEditNoteBtn" onclick="saveEditNote()">Save Note</button>
      </div>
    </div>
  </div>

  <!-- Add Tag Modal -->
  <div class="modal-overlay" id="addTagModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Add Tag</h3>
        <button class="modal-close" onclick="closeAddTagModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Tag Name</label>
          <input type="text" id="newTagInput" class="input" placeholder="Enter tag name..." maxlength="50" onkeypress="if(event.key==='Enter')saveNewTag()">
        </div>
        <div class="form-group" style="margin-top: var(--spacing-md);">
          <label class="form-label" style="margin-bottom: var(--spacing-sm);">Quick Tags</label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button type="button" class="tag" style="cursor: pointer; border: none;" onclick="selectQuickTag('Hot Lead')">üî• Hot Lead</button>
            <button type="button" class="tag vip" style="cursor: pointer; border: none;" onclick="selectQuickTag('VIP')">‚≠ê VIP</button>
            <button type="button" class="tag referral" style="cursor: pointer; border: none;" onclick="selectQuickTag('Referral')">üë• Referral</button>
            <button type="button" class="tag" style="cursor: pointer; border: none;" onclick="selectQuickTag('Follow-up')">üìû Follow-up</button>
            <button type="button" class="tag" style="cursor: pointer; border: none;" onclick="selectQuickTag('Decision Maker')">üëî Decision Maker</button>
            <button type="button" class="tag" style="cursor: pointer; border: none;" onclick="selectQuickTag('Enterprise')">üè¢ Enterprise</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddTagModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewTag()">Add Tag</button>
      </div>
    </div>
  </div>

  <!-- Page-specific functionality (INLINE) -->
  <script>
/**
 * Contact Profile Page JavaScript (Inline)
 * Handles: Contact details, call history, notes, activity timeline
 * Security: All queries filter by company_id, validate inputs, verify ownership
 */

// ===========================================
// STATE
// ===========================================
let contact = null;
let contactId = null;
let calls = [];
let notes = [];
let activities = [];
let currentTab = 'activity';
let editingNoteId = null;

// ===========================================
// TOAST NOTIFICATIONS
// ===========================================
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ===========================================
// INITIALIZATION
// ===========================================
async function initContactProfilePage() {
  // Get contact ID or phone from URL
  const params = new URLSearchParams(window.location.search);
  contactId = params.get('id');
  const phoneNumber = params.get('phone');
  const editMode = params.get('edit') === 'true';

  if (!contactId && !phoneNumber) {
    showError('.profile-layout', 'Contact ID or phone number not provided');
    return;
  }

  initPage({
    requireAuth: true,
    onReady: async (user) => {
      // Update user display
      if (user) {
        const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
        document.getElementById('userName').textContent = name;
        document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
      }

      // Load contact data - by ID or by phone
      if (contactId) {
        await loadContact();
      } else if (phoneNumber) {
        await loadContactByPhone(phoneNumber);
      }

      // Only enter edit mode if contact was loaded successfully
      if (editMode && contact) {
        editContact();
      }
    },
    onError: (error) => {
      console.error('Contact profile page init error:', error);
      showError('.profile-layout', 'Failed to initialize page');
    }
  });
}

// ===========================================
// DATA LOADING
// ===========================================

async function loadContactByPhone(phone) {
  try {
    const { companyId, error: membershipError } = await getCompanyMembership();
    if (membershipError || !companyId) {
      showError('.profile-card', 'Unable to load contact');
      return;
    }

    const cleanedPhone = phone.replace(/\D/g, '');

    const { data, error } = await supabase
      .from('contacts')
      .select('id, first_name, last_name, phone, email, business_name, job_title, source, status, tags, notes, created_at')
      .eq('company_id', companyId)
      .or(`phone.eq.${phone},phone.eq.${cleanedPhone},phone.eq.+1${cleanedPhone},phone.eq.+${cleanedPhone}`)
      .limit(1)
      .maybeSingle();

    if (error) {
      console.error('Error loading contact by phone:', error);
    }

    if (data) {
      contact = data;
      contactId = data.id;
      renderContactProfile();

      await Promise.all([
        loadContactCalls(),
        loadContactNotes(),
        loadContactActivity()
      ]);
      await loadContactStats();
    } else {
      contact = {
        id: null,
        first_name: 'Unknown',
        last_name: 'Caller',
        phone: phone,
        email: null,
        business_name: null,
        status: 'new',
        source: 'inbound_call',
        created_at: new Date().toISOString()
      };
      renderContactProfile();
      await loadCallsByPhone(phone, companyId);
    }

  } catch (error) {
    console.error('Error loading contact by phone:', error);
    showError('.profile-card', 'Failed to load contact');
  }
}

async function loadCallsByPhone(phone, companyId) {
  try {
    const cleanedPhone = phone.replace(/\D/g, '');

    const { data, error } = await supabase
      .from('calls')
      .select('id, external_call_id, phone_number, direction, status, duration_seconds, outcome, recording_url, ai_summary, notes, started_at, ended_at')
      .eq('company_id', companyId)
      .or(`phone_number.eq.${phone},phone_number.eq.${cleanedPhone},phone_number.eq.+1${cleanedPhone},phone_number.eq.+${cleanedPhone}`)
      .order('started_at', { ascending: false })
      .limit(50);

    if (error) {
      console.error('Error loading calls by phone:', error);
      return;
    }

    calls = data || [];
    renderCallHistory();
    updateCallsBadge();
    loadContactStats();

  } catch (error) {
    console.error('Error loading calls by phone:', error);
  }
}

async function loadContact() {
  try {
    const { companyId, error: membershipError } = await getCompanyMembership();
    if (membershipError || !companyId) {
      showError('.profile-card', 'Unable to load contact');
      return;
    }

    const { data, error } = await supabase
      .from('contacts')
      .select('id, first_name, last_name, phone, email, business_name, job_title, source, status, tags, notes, created_at')
      .eq('id', contactId)
      .eq('company_id', companyId)
      .single();

    if (error || !data) {
      console.error('Error loading contact:', error);
      showError('.profile-card', 'Contact not found or access denied');
      return;
    }

    contact = data;
    renderContactProfile();

    await Promise.all([
      loadContactCalls(),
      loadContactNotes(),
      loadContactActivity()
    ]);

    await loadContactStats();

  } catch (error) {
    console.error('Error loading contact:', error);
    showError('.profile-card', 'Failed to load contact');
  }
}

async function loadContactCalls() {
  try {
    const { companyId } = await getCompanyMembership();
    if (!companyId) return;

    const { data, error } = await supabase
      .from('calls')
      .select('id, external_call_id, direction, status, duration_seconds, outcome, recording_url, ai_summary, started_at, ended_at')
      .eq('contact_id', contactId)
      .eq('company_id', companyId)
      .order('started_at', { ascending: false })
      .limit(50);

    if (error) {
      console.error('Error loading calls:', error);
      return;
    }

    calls = data || [];
    renderCallHistory();
    updateCallsBadge();

  } catch (error) {
    console.error('Error loading calls:', error);
  }
}

// ISSUE-305 FIX: Added company_id filter to notes query
async function loadContactNotes() {
  try {
    const { companyId } = await getCompanyMembership();
    if (!companyId) return;

    const { data, error } = await supabase
      .from('contact_notes')
      .select(`
        id, content, is_pinned, created_at,
        created_by:users(id, full_name, email)
      `)
      .eq('contact_id', contactId)
      .eq('company_id', companyId) // ISSUE-305 FIX: Added company_id filter
      .order('is_pinned', { ascending: false })
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) {
      console.error('Error loading notes:', error);
      return;
    }

    notes = data || [];
    renderNotes();
    updateNotesBadge();

  } catch (error) {
    console.error('Error loading notes:', error);
  }
}

async function loadContactActivity() {
  try {
    const { companyId } = await getCompanyMembership();
    if (!companyId) return;

    const { data, error } = await supabase
      .from('activity_log')
      .select('id, action, entity_type, metadata, created_at')
      .eq('contact_id', contactId)
      .eq('company_id', companyId)
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) {
      console.error('Error loading activity:', error);
      return;
    }

    activities = data || [];
    renderActivityTimeline();

  } catch (error) {
    console.error('Error loading activity:', error);
  }
}

async function loadContactStats() {
  if (!contact) return;

  const totalCalls = calls.length;
  const connectedCalls = calls.filter(c => c.status === 'connected' || c.status === 'completed').length;
  const totalDuration = calls.reduce((sum, c) => sum + (c.duration_seconds || 0), 0);

  document.querySelector('.quick-stat.primary .quick-stat-value').textContent = totalCalls;
  document.querySelector('.quick-stat.success .quick-stat-value').textContent = connectedCalls;
  document.querySelector('.quick-stat.warning .quick-stat-value').textContent = formatDurationShort(totalDuration);
}

// ===========================================
// RENDERING
// ===========================================
function renderContactProfile() {
  if (!contact) return;

  const fullName = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() || 'Unknown';
  const initials = getInitials(contact.first_name, contact.last_name);

  document.getElementById('profileAvatar').textContent = initials;
  document.getElementById('profileName').textContent = fullName;
  document.getElementById('profileCompany').textContent = contact.business_name || '';

  const statusEl = document.getElementById('profileStatus');
  statusEl.className = `profile-status ${contact.status || 'new'}`;
  statusEl.innerHTML = `<span class="dot"></span> ${capitalizeFirst(contact.status || 'new')} Lead`;

  updateDetailValue('.profile-detail-item:nth-child(1) .profile-detail-value', contact.phone ? `<a href="tel:${contact.phone}">${formatPhone(contact.phone)}</a>` : 'No phone');
  updateDetailValue('.profile-detail-item:nth-child(2) .profile-detail-value', contact.email ? `<a href="mailto:${contact.email}">${escapeHtml(contact.email)}</a>` : 'No email');
  updateDetailValue('.profile-detail-item:nth-child(3) .profile-detail-value', contact.business_name || 'No company');
  updateDetailValue('.profile-detail-item:nth-child(4) .profile-detail-value', contact.job_title || 'No title');
  updateDetailValue('.profile-detail-item:nth-child(5) .profile-detail-value', capitalizeFirst(contact.source || 'manual'));
  updateDetailValue('.profile-detail-item:nth-child(6) .profile-detail-value', formatDate(contact.created_at));

  renderTags();
}

function updateDetailValue(selector, value) {
  const el = document.querySelector(selector);
  if (el) el.innerHTML = value;
}

function renderTags() {
  const tagsContainer = document.querySelector('.tags-list');
  if (!tagsContainer) return;

  const tags = contact.tags || [];
  let tagsHtml = tags.map(tag => {
    const tagClass = getTagClass(tag);
    return `<span class="tag ${tagClass}">${escapeHtml(tag)}</span>`;
  }).join('');

  tagsHtml += `<button class="add-tag-btn" onclick="addTag()">+ Add Tag</button>`;
  tagsContainer.innerHTML = tagsHtml;
}

function getTagClass(tag) {
  const lowerTag = tag.toLowerCase();
  if (lowerTag.includes('hot') || lowerTag.includes('urgent')) return 'hot';
  if (lowerTag.includes('vip') || lowerTag.includes('important')) return 'vip';
  if (lowerTag.includes('referral')) return 'referral';
  return '';
}

function renderCallHistory() {
  const container = document.querySelector('#callsTab .activity-card > div:last-child');
  if (!container) return;

  if (calls.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <div class="empty-state-icon">üìû</div>
        <div class="empty-state-title">No calls yet</div>
        <div class="empty-state-text">Call history will appear here</div>
      </div>
    `;
    return;
  }

  container.innerHTML = calls.map(call => {
    const iconClass = getCallIconClass(call.status);
    const statusText = getCallStatusText(call);

    return `
      <div class="call-history-item" onclick="viewCallDetails('${call.id}')">
        <div class="call-icon ${iconClass}">${getCallIcon(call.direction, call.status)}</div>
        <div class="call-info">
          <div class="call-title">${capitalizeFirst(call.direction || 'outbound')} Call - ${capitalizeFirst(call.status || 'unknown')}</div>
          <div class="call-meta">
            <span>${call.duration_seconds ? formatDuration(call.duration_seconds) + ' duration' : statusText}</span>
            <span>‚Ä¢</span>
            <span>${timeAgo(call.started_at)}</span>
          </div>
        </div>
        <div class="call-actions">
          ${call.recording_url ? '<button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); playRecording(\'' + call.recording_url + '\')">üéß</button>' : ''}
          ${call.ai_summary ? '<button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewTranscript(\'' + call.id + '\')">üìÑ</button>' : ''}
        </div>
      </div>
    `;
  }).join('');
}

// ISSUE-307 FIX: Notes render into container, not static HTML
function renderNotes() {
  const container = document.getElementById('notesContainer');
  if (!container) return;

  if (notes.length === 0) {
    container.innerHTML = `
      <div class="note-item">
        <div class="empty-state" style="padding: 20px;">
          <div class="empty-state-text">No notes yet. Add your first note above.</div>
        </div>
      </div>
    `;
    return;
  }

  container.innerHTML = notes.map(note => {
    const authorName = note.created_by?.full_name || note.created_by?.email?.split('@')[0] || 'Unknown';
    const authorInitials = getInitials(authorName.split(' ')[0], authorName.split(' ')[1] || '');

    return `
      <div class="note-item" data-id="${note.id}">
        <div class="note-header">
          <div class="note-author">
            <div class="note-author-avatar">${authorInitials}</div>
            <span class="note-author-name">${escapeHtml(authorName)}</span>
            ${note.is_pinned ? '<span class="tag" style="font-size: 0.6875rem; padding: 2px 6px;">üìå Pinned</span>' : ''}
          </div>
          <span class="note-time">${timeAgo(note.created_at)}</span>
        </div>
        <div class="note-content ${note.is_pinned ? 'pinned' : ''}">${escapeHtml(note.content)}</div>
        <div class="note-actions">
          <button class="note-action-btn" onclick="${note.is_pinned ? 'unpinNote' : 'pinNote'}('${note.id}')">${note.is_pinned ? 'üìå Unpin' : 'üìå Pin'}</button>
          <button class="note-action-btn" onclick="editNote('${note.id}')">‚úèÔ∏è Edit</button>
          <button class="note-action-btn" onclick="deleteNote('${note.id}')">üóëÔ∏è Delete</button>
        </div>
      </div>
    `;
  }).join('');
}

function renderActivityTimeline() {
  const container = document.querySelector('.activity-timeline');
  if (!container) return;

  const timelineItems = [
    ...calls.map(c => ({
      type: c.status === 'missed' || c.status === 'no-answer' ? 'missed' : 'call',
      title: `${capitalizeFirst(c.direction || 'Outbound')} Call - ${capitalizeFirst(c.status || 'Unknown')}`,
      description: c.notes || (c.status === 'connected' ? 'Call completed successfully' : ''),
      time: c.started_at,
      duration: c.duration,
      outcome: c.outcome,
      id: c.id,
      hasRecording: !!c.recording_url,
      hasTranscript: !!c.transcript
    })),
    ...notes.map(n => ({
      type: 'note',
      title: 'Note Added',
      description: n.content,
      time: n.created_at,
      author: n.created_by?.full_name || 'Unknown'
    })),
    ...activities.filter(a => a.action !== 'call' && a.action !== 'note').map(a => ({
      type: getActivityType(a.action),
      title: getActivityTitle(a),
      description: getActivityDescription(a),
      time: a.created_at
    }))
  ].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 20);

  if (timelineItems.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <div class="empty-state-icon">üìã</div>
        <div class="empty-state-title">No activity yet</div>
        <div class="empty-state-text">Activity will appear here as you interact with this contact</div>
      </div>
    `;
    return;
  }

  container.innerHTML = timelineItems.map(item => {
    const iconClass = getTimelineIconClass(item.type);
    const icon = getTimelineIcon(item.type);

    let detailsHtml = '';
    if (item.type === 'call' && item.duration) {
      detailsHtml = `
        <div class="timeline-details">
          <div class="timeline-details-row">
            <span class="timeline-details-label">Duration</span>
            <span class="timeline-details-value">${formatDuration(item.duration)}</span>
          </div>
          ${item.outcome ? `
          <div class="timeline-details-row">
            <span class="timeline-details-label">Outcome</span>
            <span class="timeline-details-value">${escapeHtml(item.outcome)}</span>
          </div>
          ` : ''}
        </div>
      `;
    }

    let actionsHtml = '';
    if (item.type === 'call') {
      actionsHtml = `
        <div class="timeline-actions">
          ${item.hasRecording ? '<button class="btn btn-sm btn-secondary" onclick="playRecording()">üéß Listen</button>' : ''}
          ${item.hasTranscript ? '<button class="btn btn-sm btn-secondary" onclick="viewTranscript(\'' + item.id + '\')">üìÑ Transcript</button>' : ''}
        </div>
      `;
    }

    return `
      <div class="timeline-item">
        <div class="timeline-icon ${iconClass}">${icon}</div>
        <div class="timeline-content">
          <div class="timeline-header">
            <span class="timeline-title">${escapeHtml(item.title)}</span>
            <span class="timeline-time">${timeAgo(item.time)}</span>
          </div>
          ${item.description ? `<div class="timeline-description">${escapeHtml(item.description)}</div>` : ''}
          ${detailsHtml}
          ${actionsHtml}
        </div>
      </div>
    `;
  }).join('');
}

function updateCallsBadge() {
  const badge = document.querySelector('[data-tab="calls"] .badge');
  if (badge) badge.textContent = calls.length;
}

function updateNotesBadge() {
  const badge = document.querySelector('[data-tab="notes"] .badge');
  if (badge) badge.textContent = notes.length;
}

// ===========================================
// NOTES CRUD (ISSUE-308 FIX: Added loading states)
// ===========================================
function togglePinNote() {
  const pinBtn = document.getElementById('pinNoteBtn');
  if (pinBtn) {
    pinBtn.classList.toggle('active');
  }
}

async function handleAddNote() {
  const textarea = document.getElementById('newNoteContent');
  const content = textarea?.value?.trim();
  const addBtn = document.getElementById('addNoteBtn');

  if (!content) {
    showToast('Please enter a note', 'error');
    return;
  }

  if (content.length > 5000) {
    showToast('Note must be less than 5000 characters', 'error');
    return;
  }

  if (addBtn) addBtn.classList.add('loading');

  try {
    const { user } = await getCurrentUser();
    if (!user) {
      showToast('Please log in to add notes', 'error');
      return;
    }

    const { companyId } = await getCompanyMembership();
    if (!companyId) {
      showToast('Unable to add note', 'error');
      return;
    }

    const isPinned = document.getElementById('pinNoteBtn')?.classList.contains('active') || false;

    const { data, error } = await supabase
      .from('contact_notes')
      .insert({
        contact_id: contactId,
        company_id: companyId,
        content: content,
        is_pinned: isPinned,
        created_by: user.id
      })
      .select()
      .single();

    if (error) {
      console.error('Error adding note:', error);
      showToast('Failed to add note', 'error');
      return;
    }

    textarea.value = '';
    document.getElementById('pinNoteBtn')?.classList.remove('active');
    await loadContactNotes();
    showToast('Note added successfully', 'success');

  } catch (error) {
    console.error('Error adding note:', error);
    showToast('Failed to add note', 'error');
  } finally {
    if (addBtn) addBtn.classList.remove('loading');
  }
}

async function pinNote(noteId) {
  await updateNote(noteId, { is_pinned: true });
}

async function unpinNote(noteId) {
  await updateNote(noteId, { is_pinned: false });
}

async function updateNote(noteId, updates) {
  const noteItem = document.querySelector(`.note-item[data-id="${noteId}"]`);
  const actionBtns = noteItem?.querySelectorAll('.note-action-btn');
  actionBtns?.forEach(btn => btn.classList.add('loading'));

  try {
    const { companyId } = await getCompanyMembership();
    if (!companyId) {
      showToast('Not authorized', 'error');
      return;
    }

    const { data: noteData } = await supabase
      .from('contact_notes')
      .select('contact_id')
      .eq('id', noteId)
      .single();

    if (!noteData) {
      showToast('Note not found', 'error');
      return;
    }

    const { data: contactData } = await supabase
      .from('contacts')
      .select('company_id')
      .eq('id', noteData.contact_id)
      .single();

    if (!contactData || contactData.company_id !== companyId) {
      showToast('Not authorized to update this note', 'error');
      return;
    }

    const { error } = await supabase
      .from('contact_notes')
      .update(updates)
      .eq('id', noteId)
      .eq('contact_id', contactId);

    if (error) {
      console.error('Error updating note:', error);
      showToast('Failed to update note', 'error');
      return;
    }

    await loadContactNotes();
    showToast('Note updated', 'success');

  } catch (error) {
    console.error('Error updating note:', error);
    showToast('Failed to update note', 'error');
  } finally {
    actionBtns?.forEach(btn => btn.classList.remove('loading'));
  }
}

async function deleteNote(noteId) {
  if (!confirm('Are you sure you want to delete this note?')) {
    return;
  }

  const noteItem = document.querySelector(`.note-item[data-id="${noteId}"]`);
  const actionBtns = noteItem?.querySelectorAll('.note-action-btn');
  actionBtns?.forEach(btn => btn.classList.add('loading'));

  try {
    const { companyId } = await getCompanyMembership();
    if (!companyId) {
      showToast('Not authorized', 'error');
      return;
    }

    const { data: noteData } = await supabase
      .from('contact_notes')
      .select('contact_id')
      .eq('id', noteId)
      .single();

    if (!noteData) {
      showToast('Note not found', 'error');
      return;
    }

    const { data: contactData } = await supabase
      .from('contacts')
      .select('company_id')
      .eq('id', noteData.contact_id)
      .single();

    if (!contactData || contactData.company_id !== companyId) {
      showToast('Not authorized to delete this note', 'error');
      return;
    }

    const { error } = await supabase
      .from('contact_notes')
      .delete()
      .eq('id', noteId)
      .eq('contact_id', contactId);

    if (error) {
      console.error('Error deleting note:', error);
      showToast('Failed to delete note', 'error');
      return;
    }

    await loadContactNotes();
    showToast('Note deleted', 'success');

  } catch (error) {
    console.error('Error deleting note:', error);
    showToast('Failed to delete note', 'error');
  }
}

// ISSUE-306 FIX: Use modal instead of prompt() for editing notes
function editNote(noteId) {
  const note = notes.find(n => n.id === noteId);
  if (!note) return;

  editingNoteId = noteId;
  document.getElementById('editNoteContent').value = note.content;
  document.getElementById('editNoteModal').classList.add('active');
}

function closeEditNoteModal() {
  document.getElementById('editNoteModal').classList.remove('active');
  editingNoteId = null;
}

async function saveEditNote() {
  if (!editingNoteId) return;

  const content = document.getElementById('editNoteContent').value.trim();
  if (!content) {
    showToast('Note content cannot be empty', 'error');
    return;
  }

  const saveBtn = document.getElementById('saveEditNoteBtn');
  if (saveBtn) saveBtn.classList.add('loading');

  await updateNote(editingNoteId, { content: content });
  closeEditNoteModal();

  if (saveBtn) saveBtn.classList.remove('loading');
}

// ===========================================
// CONTACT ACTIONS
// ===========================================
function callContact() {
  if (contact && contact.phone) {
    const name = encodeURIComponent(`${contact.first_name || ''} ${contact.last_name || ''}`.trim());
    window.location.href = `call.html?number=${encodeURIComponent(contact.phone)}&name=${name}`;
  }
}

async function addToQueue() {
  console.log('addToQueue called, contactId:', contactId);
  showToast('Adding to queue...', 'info');

  try {
    const { companyId, error: membershipError } = await getCompanyMembership();
    console.log('Company membership:', { companyId, membershipError });

    if (!companyId) {
      showToast('Unable to add to queue - please refresh and try again', 'error');
      return;
    }

    let currentContactId = contactId;
    if (!currentContactId && contact && contact.phone) {
      const { user } = await getCurrentUser();

      const { data: newContact, error: createError } = await supabase
        .from('contacts')
        .insert({
          company_id: companyId,
          phone: contact.phone,
          first_name: contact.first_name || 'Unknown',
          last_name: contact.last_name || 'Caller',
          source: 'manual',
          status: 'new'
        })
        .select('id')
        .single();

      if (createError) {
        console.error('Error creating contact:', createError);
        showToast('Failed to create contact for queue', 'error');
        return;
      }

      currentContactId = newContact.id;
      contactId = newContact.id;
      contact.id = newContact.id;
    }

    if (!currentContactId) {
      showToast('No contact to add to queue', 'error');
      return;
    }

    const { data: existing } = await supabase
      .from('ai_queue')
      .select('id, status')
      .eq('contact_id', currentContactId)
      .in('status', ['pending', 'in_progress', 'retry_scheduled'])
      .maybeSingle();

    if (existing) {
      showToast('This contact is already in the queue', 'warning');
      return;
    }

    const { error } = await supabase
      .from('ai_queue')
      .insert({
        company_id: companyId,
        contact_id: currentContactId,
        status: 'pending',
        priority: 2
      });

    if (error) {
      console.error('Error adding to queue:', error);
      showToast('Failed to add to queue: ' + error.message, 'error');
      return;
    }

    console.log('Successfully added to queue');
    const name = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() || 'Contact';
    showToast(`${name} added to call queue!`, 'success');

  } catch (error) {
    console.error('Exception in addToQueue:', error);
    showToast('Failed to add to queue - check console for details', 'error');
  }
}

function sendEmail() {
  if (contact && contact.email) {
    window.location.href = `mailto:${contact.email}`;
  } else {
    showToast('No email address available', 'error');
  }
}

// ISSUE-304 FIX: Implement editContact() with modal form
function editContact() {
  if (!contact) {
    showToast('No contact to edit', 'error');
    return;
  }

  document.getElementById('editFirstName').value = contact.first_name || '';
  document.getElementById('editLastName').value = contact.last_name || '';
  document.getElementById('editPhone').value = contact.phone || '';
  document.getElementById('editEmail').value = contact.email || '';
  document.getElementById('editCompany').value = contact.business_name || '';
  document.getElementById('editTitle').value = contact.job_title || '';
  document.getElementById('editStatus').value = contact.status || 'new';

  document.getElementById('editContactModal').classList.add('active');
}

function closeEditContactModal() {
  document.getElementById('editContactModal').classList.remove('active');
}

async function saveEditContact() {
  const saveBtn = document.getElementById('saveEditContactBtn');
  if (saveBtn) saveBtn.classList.add('loading');

  try {
    const firstName = document.getElementById('editFirstName').value.trim();
    const lastName = document.getElementById('editLastName').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const company = document.getElementById('editCompany').value.trim();
    const jobTitle = document.getElementById('editTitle').value.trim();
    const status = document.getElementById('editStatus').value;

    if (!firstName) {
      showToast('First name is required', 'error');
      return;
    }
    if (!lastName) {
      showToast('Last name is required', 'error');
      return;
    }
    if (!phone) {
      showToast('Phone is required', 'error');
      return;
    }

    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('Please enter a valid email address', 'error');
      return;
    }

    const { companyId } = await getCompanyMembership();
    if (!companyId) {
      showToast('Not authorized', 'error');
      return;
    }

    const { error } = await supabase
      .from('contacts')
      .update({
        first_name: firstName,
        last_name: lastName,
        phone: phone,
        email: email || null,
        business_name: company || null,
        job_title: jobTitle || null,
        status: status
      })
      .eq('id', contactId)
      .eq('company_id', companyId);

    if (error) {
      console.error('Error updating contact:', error);
      showToast('Failed to update contact', 'error');
      return;
    }

    closeEditContactModal();
    showToast('Contact updated!', 'success');

    await loadContact();

  } catch (error) {
    console.error('Error updating contact:', error);
    showToast('Failed to update contact', 'error');
  } finally {
    if (saveBtn) saveBtn.classList.remove('loading');
  }
}

function showMoreOptions() {
  if (confirm('Delete this contact?')) {
    deleteContact();
  }
}

async function deleteContact() {
  if (!confirm('Are you sure you want to delete this contact? This action cannot be undone.')) {
    return;
  }

  try {
    const { companyId } = await getCompanyMembership();
    if (!companyId) {
      showToast('Not authorized', 'error');
      return;
    }

    const { error } = await supabase
      .from('contacts')
      .delete()
      .eq('id', contactId)
      .eq('company_id', companyId);

    if (error) {
      console.error('Error deleting contact:', error);
      showToast('Failed to delete contact', 'error');
      return;
    }

    showToast('Contact deleted', 'success');
    window.location.href = 'contacts.html';

  } catch (error) {
    console.error('Error deleting contact:', error);
    showToast('Failed to delete contact', 'error');
  }
}

function addTag() {
  document.getElementById('newTagInput').value = '';
  document.getElementById('addTagModal').classList.add('active');
  setTimeout(() => document.getElementById('newTagInput').focus(), 100);
}

function closeAddTagModal() {
  document.getElementById('addTagModal').classList.remove('active');
}

function selectQuickTag(tagName) {
  document.getElementById('newTagInput').value = tagName;
  saveNewTag();
}

async function saveNewTag() {
  const input = document.getElementById('newTagInput');
  const tag = input.value.trim();

  if (!tag) {
    showToast('Please enter a tag name', 'warning');
    return;
  }

  if (tag.length > 50) {
    showToast('Tag must be less than 50 characters', 'error');
    return;
  }

  try {
    const currentTags = contact.tags || [];
    if (currentTags.includes(tag)) {
      showToast('Tag already exists', 'warning');
      return;
    }

    const { companyId } = await getCompanyMembership();
    if (!companyId) {
      showToast('Unable to add tag', 'error');
      return;
    }

    const { error } = await supabase
      .from('contacts')
      .update({ tags: [...currentTags, tag] })
      .eq('id', contactId)
      .eq('company_id', companyId);

    if (error) {
      console.error('Error adding tag:', error);
      showToast('Failed to add tag', 'error');
      return;
    }

    contact.tags = [...currentTags, tag];
    renderTags();
    closeAddTagModal();
    showToast('Tag added', 'success');

  } catch (error) {
    console.error('Error adding tag:', error);
    showToast('Failed to add tag', 'error');
  }
}

// ===========================================
// CALL ACTIONS
// ===========================================
function viewCallDetails(callId) {
  const call = calls.find(c => c.id === callId);
  if (call) {
    showToast(`Call: ${call.status} - ${formatDuration(call.duration_seconds)} on ${formatDateTime(call.started_at)}`, 'info');
  }
}

function playRecording(url) {
  if (url) {
    window.open(url, '_blank');
  } else {
    showToast('Recording not available', 'error');
  }
}

function viewTranscript(callId) {
  const call = calls.find(c => c.id === callId);
  if (call && call.ai_summary) {
    const summary = typeof call.ai_summary === 'string'
      ? JSON.parse(call.ai_summary)
      : call.ai_summary;
    alert(`Call Summary:\n\n${summary.overview || summary.summary || JSON.stringify(summary, null, 2)}`);
  } else {
    showToast('Summary not available', 'error');
  }
}

// ===========================================
// TAB SWITCHING
// ===========================================
function switchTab(tabName) {
  currentTab = tabName;

  document.querySelectorAll('.profile-tab').forEach(tab => {
    tab.classList.remove('active');
    if (tab.dataset.tab === tabName) {
      tab.classList.add('active');
    }
  });

  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(tabName + 'Tab')?.classList.add('active');
}

// ===========================================
// UTILITIES
// ===========================================
function getInitials(firstName, lastName) {
  const first = (firstName || '').charAt(0).toUpperCase();
  const last = (lastName || '').charAt(0).toUpperCase();
  return first + last || '??';
}

function capitalizeFirst(str) {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function formatDuration(seconds) {
  if (!seconds) return '0:00';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatDurationShort(seconds) {
  if (!seconds) return '0m';
  const mins = Math.floor(seconds / 60);
  if (mins < 60) return `${mins}m`;
  const hours = Math.floor(mins / 60);
  return `${hours}h ${mins % 60}m`;
}

function getCallIconClass(status) {
  switch (status) {
    case 'connected':
    case 'completed':
      return 'connected';
    case 'missed':
    case 'no-answer':
      return 'missed';
    case 'voicemail':
      return 'voicemail';
    default:
      return 'outbound';
  }
}

function getCallIcon(direction, status) {
  if (status === 'missed' || status === 'no-answer') return 'üìµ';
  return direction === 'inbound' ? 'üì≤' : 'üìû';
}

function getCallStatusText(call) {
  switch (call.status) {
    case 'missed':
    case 'no-answer':
      return 'No answer';
    case 'voicemail':
      return 'Voicemail left';
    case 'busy':
      return 'Line busy';
    default:
      return capitalizeFirst(call.status || 'unknown');
  }
}

function getTimelineIconClass(type) {
  switch (type) {
    case 'call': return 'call';
    case 'missed': return 'missed';
    case 'note': return 'note';
    case 'email': return 'email';
    case 'stage': return 'stage';
    case 'created': return 'created';
    default: return '';
  }
}

function getTimelineIcon(type) {
  switch (type) {
    case 'call': return 'üìû';
    case 'missed': return 'üìµ';
    case 'note': return 'üìù';
    case 'email': return '‚úâÔ∏è';
    case 'stage': return 'üéØ';
    case 'created': return '‚ûï';
    default: return 'üìã';
  }
}

function getActivityType(action) {
  if (action.includes('stage') || action.includes('status')) return 'stage';
  if (action.includes('email')) return 'email';
  if (action === 'created') return 'created';
  return 'note';
}

function getActivityTitle(activity) {
  const action = activity.action || '';
  if (action.includes('stage')) return 'Stage Changed';
  if (action.includes('status')) return 'Status Updated';
  if (action === 'created') return 'Contact Created';
  return capitalizeFirst(action);
}

function getActivityDescription(activity) {
  const metadata = activity.metadata || {};
  if (metadata.from && metadata.to) {
    return `${metadata.from} ‚Üí ${metadata.to}`;
  }
  return metadata.description || '';
}

// ===========================================
// SIDEBAR
// ===========================================
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('collapsed');
  localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
}

function openSidebar() {
  document.getElementById('sidebar').classList.add('mobile-open');
  document.getElementById('sidebarOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('sidebarOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

// ===========================================
// PLACEHOLDERS
// ===========================================
function viewEmail(emailId) {
  showToast(`View email #${emailId} - coming soon`, 'info');
}

function composeEmail() {
  if (contact && contact.email) {
    window.location.href = `mailto:${contact.email}`;
  } else {
    showToast('No email address available', 'error');
  }
}

function uploadFile() {
  showToast('File upload - coming soon', 'info');
}

// ===========================================
// INITIALIZE
// ===========================================
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    const savedCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (savedCollapsed && window.innerWidth > 1024) {
      document.getElementById('sidebar').classList.add('collapsed');
    }
    initContactProfilePage();
  });
} else {
  const savedCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
  if (savedCollapsed && window.innerWidth > 1024) {
    document.getElementById('sidebar').classList.add('collapsed');
  }
  initContactProfilePage();
}
  </script>
</body>
</html>
